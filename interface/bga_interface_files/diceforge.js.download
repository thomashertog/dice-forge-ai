define(["dojo","dojo/_base/declare","dojo/_base/lang","dojo/NodeList-traverse","ebg/core/gamegui","ebg/counter","ebg/stock","ebg/zone"],(function(e,t){return t("bgagame.diceforge",ebg.core.gamegui,{constructor:function(){var t=this;this.statesInfo={};this.pools=[];this.zones=[];this.exploits=[];this.isTouchScreen=!1;this.selectForge={isInit:!1,forgeType:!1,sideToForge:!1,isForging:!1,poolList:null,init:function(e){e=null==e?{}:e;this.forgeType=null==e.forgeType?"gold":e.forgeType;this.sideToForge=null!=e.sideToForge&&e.sideToForge;this.isForging=null!=e.isForging&&e.isForging;this.poolList=null==e.poolList?null:e.poolList;this.activatePoolSides();this.isInit=!0},end:function(){if(this.isInit){e.query("#player-container-"+t.player_id+" .dices-container").removeClass("flat");this.deactivatePoolSides();this.deactivateSelfSides();this.isInit=!1}},getSideToForge:function(){if(this.sideToForge)return this.sideToForge;var e=!1;for(var i in t.pools)t.pools[i].getSelectedItems().length&&(e=t.pools[i].getSelectedItems()[0].id);return e},getSideToReplace:function(){return!!e.query(".bside.selected").length&&e.query(".bside.selected")[0].id.match(/side_flat_([0-9]+)/)[1]},resetSelection:function(){e.query(".bside.selected").removeClass("selected");if(null==this.sideToForge||!this.sideToForge)for(var i in t.pools)t.pools[i].unselectAll()},activatePoolSides:function(){switch(this.forgeType){case"gold":for(var i in t.pools)if(!(i>10)){e.query("#pool-"+i).addClass("clickable");t.pools[i].setSelectionMode(1);t.connexions["pool"+i]=e.connect(t.pools[i],"onChangeSelection",t,"onClickForgePoolSide")}break;case"mirror":if(this.sideToForge){t.pools[11].selectItem(this.sideToForge);this.activateSelfSides()}else{e.query("#pool-11").addClass("clickable");t.pools[11].setSelectionMode(1);t.connexions.pool11=e.connect(t.pools[11],"onChangeSelection",t,"onClickForgePoolSide")}break;case"shield":e.query("#pool-12").addClass("clickable");t.pools[12].setSelectionMode(1);t.connexions.pool12=e.connect(t.pools[12],"onChangeSelection",t,"onClickForgePoolSide");break;case"ship":if(this.sideToForge){t.pools[13].selectItem(this.sideToForge);this.activateSelfSides()}else{e.query("#pool-13").addClass("clickable");t.pools[13].setSelectionMode(1);t.connexions.pool13=e.connect(t.pools[13],"onChangeSelection",t,"onClickForgePoolSide")}break;case"boar":t.pools[14].selectItem(this.sideToForge);this.activateSelfSides();break;case"triple":if(this.sideToForge){t.pools[15].selectItem(this.sideToForge);this.activateSelfSides()}else{e.query("#pool-15").addClass("clickable");t.pools[15].setSelectionMode(1);t.connexions.pool15=e.connect(t.pools[15],"onChangeSelection",t,"onClickForgePoolSide")}break;case"all":for(var i in t.pools){e.query("#pool-"+i).addClass("clickable");t.pools[i].setSelectionMode(1);t.connexions["pool"+i]=e.connect(t.pools[i],"onChangeSelection",t,"onClickForgePoolSide")}break;case"select":for(var s in this.poolList){i=this.poolList[s];e.query("#pool-"+i).addClass("clickable");if(t.pools.hasOwnProperty(i)){t.pools[i].setSelectionMode(1);t.connexions["pool"+i]=e.connect(t.pools[i],"onChangeSelection",t,"onClickForgePoolSide")}}break;case"moonGolem":if(this.sideToForge){t.pools[19].selectItem(this.sideToForge);this.activateSelfSides()}else{e.query("#pool-19").addClass("clickable");t.pools[19].setSelectionMode(1);t.connexions.pool19=e.connect(t.pools[19],"onChangeSelection",t,"onClickForgePoolSide")}break;case"sunGolem":if(this.sideToForge){t.pools[17].selectItem(this.sideToForge);this.activateSelfSides()}else{e.query("#pool-17").addClass("clickable");t.pools[17].setSelectionMode(1);t.connexions.pool17=e.connect(t.pools[17],"onChangeSelection",t,"onClickForgePoolSide")}break;case"dogged":e.query("#pool-18").addClass("clickable");t.pools[18].setSelectionMode(1);t.connexions.pool18=e.connect(t.pools[18],"onChangeSelection",t,"onClickForgePoolSide");break;case"shieldRebellion":e.query("#pool-20").addClass("clickable");t.pools[20].setSelectionMode(1);t.connexions.pool20=e.connect(t.pools[20],"onChangeSelection",t,"onClickForgePoolSide");break;case"misfortune":t.pools[16].selectItem(this.sideToForge);this.activateSelfSides()}},deactivatePoolSides:function(){for(var i in t.pools){if(t.connexions.hasOwnProperty("pool"+i)){e.disconnect(t.connexions["pool"+i]);delete t.connexions["pool"+i]}t.pools[i].setSelectionMode(0)}e.query(".pool").removeClass("clickable");e.query(".stockitem").removeClass("stockitem_selected")},activateSelfSides:function(){e.query(".current-player-play-area .dice-flat .bside").addClass("clickable");t.connexions.forge=e.query(".current-player-play-area .bside").map((function(i){return e.connect(i,"onclick",t,"onClickForgeSelfSide")}))},deactivateSelfSides:function(){e.query(".current-player-play-area .bside.clickable").removeClass("clickable");if(t.connexions.hasOwnProperty("forge")){e.forEach(t.connexions.forge,(function(t){e.disconnect(t)}));delete t.connexions.forge}}};this.selfSides={connexions:!1,sidesSelected:[],selectionMode:"",selectionCallback:"",activate:function(i,s){this.selectionMode=null==i?"OneSidePerDice":i;this.selectionCallback=null==s?"onClickConfirmSelfSideSelection":s;this.sidesSelected=[];e.query(".current-player-play-area .dice-flat .bside").addClass("clickable");this.connexions=e.query(".current-player-play-area .bside").map((function(i){return e.connect(i,"onclick",t.selfSides,"onClick"+t.selfSides.selectionMode)}))},deactivate:function(){e.query(".current-player-play-area .bside.clickable").removeClass("clickable selected");if(!1!==this.connexions){e.forEach(this.connexions,(function(t){e.disconnect(t)}));this.connexions=!1;this.sidesSelected=[]}},onClickOneSidePerDice:function(i){$side=i.target;$parent=$side.parentElement;var s=[];$parent.id.match(/player-([0-9]+)-dice-([0-9])/)[2];e.query($parent).query(".bside.selected").removeClass("selected");e.query($side).addClass("selected");e.query(".current-player-play-area .bside.selected").forEach((function(e){var t={id:e.id.match(/side_flat_([0-9]+)/)[1],type:e.getAttribute("data-type")};s.push(t)}));this.sidesSelected=s;s.length==e.query(".current-player-play-area .dice-flat").length&&t[this.selectionCallback]()},onClickOneSide:function(i){$side=i.target;e.query(".current-player-play-area").query(".bside.selected").removeClass("selected");e.query($side).addClass("selected");var s={id:$side.id.match(/side_flat_([0-9]+)/)[1],type:$side.getAttribute("data-type"),diceNum:$side.parentElement.id.match(/player-([0-9]+)-dice-([0-9])/)[2]};this.sidesSelected=[s];t[this.selectionCallback]()}};this.sidePosition=["G1","G3","G4","G6","FS1","FS2","MS1","MS2","V2","V3","V4","1Gor1FSor1MS","2Gor2FSor2MS","G2MS1","V1FS1","G3orV2","G1V1FS1MS1","V2MS2","triple","mirror","ship","ship","blueBoar","yellowBoar","redBoar","greenBoar","blueShield","yellowShield","greenShield","redShield","boar","tritonToken","AS1","L1V1","L1V1G2","G3AS1","titanBlueShield","titanYellowShield","titanRedShield","titanGreenShield","blueMisfortune","yellowMisfortune","greenMisfortune","redMisfortune","moonGolem","sunGolem","G12","V5","V3G3orFS1orMS1","celestialMirror","chooseSide","doubleUpgrade"];this.sideClass={G1:"side-g1",G3:"side-g3",G4:"side-g4",G6:"side-g6",FS1:"side-fs1",FS2:"side-fs2",MS1:"side-ms1",MS2:"side-ms2",V2:"side-vp2",V3:"side-vp3",V4:"side-vp4","1Gor1FSor1MS":"side-g1-or-fs1-or-ms1","2Gor2FSor2MS":"side-g2-or-fs2-or-ms2",G2MS1:"side-g2-plus-ms1",V1FS1:"side-vp1-plus-fs1",G3orV2:"side-g3-or-vp2",G1V1FS1MS1:"side-g1-plus-vp1-plus-fs1-plus-ms1",V2MS2:"side-vp2-plus-ms2",triple:"side-x3",mirror:"side-mirror",ship:"side-ship",blueBoar:"side-blue-boar",yellowBoar:"side-yellow-boar",redBoar:"side-red-boar",greenBoar:"side-green-boar",blueShield:"side-blue-shield",yellowShield:"side-yellow-shield",redShield:"side-red-shield",greenShield:"side-green-shield",boar:"ressources-effect-red-boar",tritonToken:"token-triton-small",AS1:"side-as1",L1V1:"side-l1-plus-v1",L1V1G2:"side-l1-plus-v1-plus-g2",G3AS1:"side-g3-plus-as1",titanBlueShield:"side-titan-blue-shield",titanYellowShield:"side-titan-yellow-shield",titanRedShield:"side-titan-red-shield",titanGreenShield:"side-titan-green-shield",blueMisfortune:"side-blue-misfortune",yellowMisfortune:"side-yellow-misfortune",greenMisfortune:"side-green-misfortune",redMisfortune:"side-red-misfortune",otherMisfor:"side-other-misfortune",moonGolem:"side-moon-golem",sunGolem:"side-sun-golem",G12:"side-g12",V5:"side-vp5",V3G3orFS1orMS1:"side-v3-plus-g3-or-fs1-or-ms1",celestialMirror:"side-celestial-mirror",chooseSide:"side-choose-side",doubleUpgrade:"side-double-upgrade",twins:"ressources-twins"};this.mazeClass={mFS1:"maze-fs1",mV3:"maze-vp3",mG6orV3:"maze-g6-or-vp3",mV5:"maze-vp5",mFS1MS1V3:"maze-vp3-fs1-ms1",mSteal2VP:"maze-steal-vp2",mTreasure:"maze-bonus",mCelestial:"maze-celestial1",mcelestialRoll:"maze-celestial1",mShip:"maze-ship-g2",mG6:"maze-g6",mMS1:"maze-ms1",mG3orMS1orFS1:"maze-g3-or-fs1-or-ms1",mForge:"maze-ship",mMS2orV3:"maze-ms2-or-vp3",mMS2orFS2:"maze-fs2-or-ms2",mCelestial2:"maze-celestial2",mcelestialRollx2:"maze-celestial2",mV15:"maze-vp15",mfirstFinish:"maze-first-finish",msteal2VP:"maze-steal-vp2",mtreasure:"maze-bonus",mforgeShip:"maze-ship-g2",mforge:"maze-ship",mconvert6Gto6VP:"maze-g6-to-vp6",mconvertMS2to8VP:"maze-ms2-to-vp8",mnone:"hide",mscoreForgedSides:"maze-side-to-vp",m15VP:"maze-vp15",mstart:"maze-start","maze-fs1":"token-small token-maze-fs1","maze-ms1":"token-small token-maze-ms1","maze-vp2":"token-small token-maze-vp2"};this.classEffect={bear:"effect-bear",redBoar:"effect-red-boar",greenBoar:"effect-green-boar",yellowBoar:"effect-yellow-boar",blueBoar:"effect-blue-boar",blueMisfortune:"effect-blue-misfortune",yellowMisfortune:"effect-yellow-misfortune",greenMisfortune:"effect-green-misfortune",redMisfortune:"effect-red-misfortune",twins:"effect-twins"};this.poolCost={1:2,2:2,3:3,4:3,5:4,6:5,7:6,8:8,9:8,10:12};this.memoryMap={blueMemory:"token-blue-memory-",yellowMemory:"token-yellow-memory-",greenMemory:"token-green-memory-",redMemory:"token-red-memory-"};this.exploitSlot=["M1","M2","M3","M4","M5","M6","M7","M8","F1","F2","F3","F4","F5","F6","F7"];this.exploitWidth=93;this.exploitHeight=144;this.exploitByRow=11;this.exploitSpritePosition={ancient:0,grass:1,owl:2,minotaure:3,medusa:4,mirror:5,enigma:6,hydra:7,claw:8,invisible:9,passeur:10,satyres:11,doe:12,chest:13,hammer:14,ship:15,shield:16,triton:17,cyclops:18,typhon:19,sentinel:20,cerberus:21,greenBoar:22,blueBoar:23,yellowBoar:24,redBoar:25,bear:26,harpy:27,chimera:28,monsterMother:29,nymphe:30,magicSeagull:31,hydraPromo:32,tree:33,woodNymph:34,sunGolem:35,timeGolem:36,goldsmith:37,trident:38,eternalFire:39,goddess:40,eternalNight:41,greatGolem:42,mists:43,celestial:44,moonGolem:45,companion:46,twins:47,merchant:48,dogged:49,guardian:50,light:51,omniscient:52,yellowMisfortune:53,leftHand:54,titan:55,rightHand:56,chaos:57,ancestor:58,wind:59,oracle:60,greenMemory:61,yellowMemory:62,blueMemory:63,redMemory:64,scepter:65,blueMisfortune:66,redMisfortune:67,greenMisfortune:68};this.exploitTypes={};this.colors={D56F12:"orange","000000":"black",B6B525:"green","5D8688":"blue"};this.currentCost=0;this.connexions={};this.pileList=["pile1","pile2","pile3"];this.playedAction="";this.clientStateArgs={};this.parentSide=[];this.diceSelectionArgs={};this.lastSideUp={};this.triple=1;this.turnPlayerId=0;this.translatableTexts={};this.currentFilter="";this.sidesInit={};this.initPools={};this.myDlg="";window.addEventListener("touchstart",(function(){t.isTouchScreen=!0}))},setup:function(t){var i=this;this.translatableTexts={question:_("?"),round:_("Round"),yes:_("Yes"),no:_("No"),cancel:_("Cancel"),pass:_("Pass"),confirm:_("Confirm"),endForgeButton:_("End Forge"),endTurnButton:_("End Turn"),tooltipCardCost:_("Cost: "),tooltipCardVP:_("VP: "),shipMultipleActionChoice:_("Choose what to do first: "),actionUseCerberusToken:_("Use your Cerberus token?"),helpActionMessage:_("Click on an action button first (top of the screen)"),mirrorDialogTitle:_("Choose ${nb} side(s) to replace the mirror(s)"),silverHindDialogTitle:_("Select a die (Silver Hind)"),oracleHindDialogTitle:_("Select a die (Oracle)"),draftNoCardSelectedError:_("You must select a card first"),draftTooManyCardSelectedError:_("Only one card can be selected"),buyExploitConfirmation:_("Please confirm you want to buy this card ?"),passReinforcementConfirmation:_("You did not use all your reinforcement(s), are you sure you want to pass ?"),forgeDescriptionMyTurn:this.divYou()+" "+_("must choose the side you want THEN where you want to forge it"),isForgingDescriptionMyTurn:this.divYou()+" "+_("may keep on forging your dices"),exploitDescriptionMyTurn:this.divYou()+" "+_("must choose an heroic feat"),tritonTokenDescriptionMyTurn:this.divYou()+" "+_("choose resources for the Token"),owlDescriptionMyTurn:this.divYou()+" "+_("must select a resource: "),satyrsDescriptionMyTurn:this.divYou()+" "+_("must select 2 sides from opponents"),minotaurDescriptionMyTurn:this.divYou()+" "+_("must choose resources to loose (Minotaur effect)"),sphinxDescriptionMyTurn:this.divYou()+" "+_("must select a die"),discardedSidesTooltipTitle:_("Discarded sides"),secondActionTooltipTitle:_("Second action taken"),firstPlayerTooltipTitle:_("First player"),lastTurnMessage:_("This is the last turn"),rollsLogButton:_("${playerName} rolls log"),rollsLogsTextSearch:_("${logPlayerName} rolls"),autoHammerEnableButton:this.replaceTextWithIcons(_("Enable Auto [H]")),autoHammerDisableButton:this.replaceTextWithIcons(_("Disable Auto [H]")),scepterTokenDescriptionMyTurn:_("Select the ressource to get"),buyWithAncientShardDescriptionMyTurn:_("Select how to accomplish the exploit"),cancelScepters:_("Reset scepter positions"),convertCompanion:_("Do you confirm the conversion of the Companion?"),merchantFirstStep:_("Choose the number of upgrade that you wish to do:"),merchantSecondStep:_("Choose the side on your die to replace THEN the new one"),upgradeNotPossible:_("This side cannot be upgraded as it has reached maximum level"),merchantTooMuchUpgrade:_("Please select less upgrade as it exceeds upgrade limit"),celestialMirror:_("Celestial Mirror: select a side to gain its resources"),celestialChooseSide:_("Select a side to put it face up and gain its resources"),reroll:_("Reroll (-3[G])"),confirmEndTurn:_("Do you wish to end your turn?"),mazeClassicalForge:_("[mForge] You may forge a side"),mazeChoosePath:_("Choose your path "),mazeChooseTreasure:_("Choose the treasure "),mazeConfirmReward:_("Confirm the reward "),celestialChooseSides:_("Select a side per die to put it face up and gain its resources"),seeDiscardTooltip:_("Click here to see your discard, then click on the panel that opened to hide it"),ancestorNoSide:_("Select a die to gain a minor blessing"),showChooseDialog:_("Show mirror dialog"),forgeOriginalSide:_("Do you confirm the replacement of an updagred side?"),notEnoughResource:_("Not enough resources"),memoryIsland:_("Select an island on which to put the reward on it")};this.exploitTypes=t.exploitTypes;this.sidesInit=t.sides_init;this.initPools=t.initPools;var s=Object.keys(t.players).length;2==s?e.addClass("game_play_area","two-players"):3==s?e.addClass("game_play_area","three-players"):4==s&&e.addClass("game_play_area","four-players");e.addClass("loader_mask","hide");var o=[{id:1111,type:"G12",class:this.sideClass.G12},{id:1112,type:"V5",class:this.sideClass.V5},{id:1131,type:"V3G3orFS1orMS1",class:this.sideClass.V3G3orFS1orMS1},{id:1114,type:"celestialMirror",class:this.sideClass.celestialMirror},{id:1115,type:"chooseSide",class:this.sideClass.chooseSide},{id:1161,type:"doubleUpgrade",class:this.sideClass.doubleUpgrade}];e.place(this.format_block("jstpl_celestial_dice",o),"pool-1","before");for(var a in t.players){var r=t.players[a],n=$("player_board_"+a);$("player-container-"+a);e.place(this.format_block("jstpl_turn_order",{order:t.turnOrder[a]}),n);if(a==this.player_id){var l=1==t.players[a].hammer_auto?this.translatableTexts.autoHammerDisableButton:this.translatableTexts.autoHammerEnableButton,c=e.place(this.format_block("jstpl_bga_btn",{color:"gray",classes:"btn-auto-hammer",id:"btn-auto-hammer",text:l}),n);e.attr(c,"data-enabled",t.players[a].hammer_auto);e.connect(c,"onclick",this,"onClickAutoHammer");$seeDiscard=document.getElementById("see-discard");e.connect($seeDiscard,"onclick",this,"onClickShowDiscard");this.addTooltipHtml($seeDiscard.id,this.format_block("jstpl_tooltip_classic",{title:this.translatableTexts.seeDiscardTooltip}));$discardOverlay=document.querySelector(".fixed-center");e.connect($discardOverlay,"onclick",this,"onClickHideDiscard");var d=e.place(this.format_block("jstpl_bga_btn",{color:"blue",classes:"btn-auto-hammer",id:"btn-show-chooser",text:this.translatableTexts.showChooseDialog}),n);e.connect(d,"onclick",this,"onClickShowDialog");e.addClass(d,"hide")}var h=e.place(this.format_block("jstpl_bga_btn",{color:"gray",classes:"btn-filter-log hide",id:"btn-filter-log-"+r.name,text:this.translatableTexts.rollsLogButton.replace("${playerName}",r.name)}),n,"last");e.connect(h,"onclick",this,"onClickFilterRolls");this.addTooltipHtml("container_discarded_sides_p"+a,this.format_block("jstpl_tooltip_classic",{title:this.translatableTexts.discardedSidesTooltipTitle}));e.place(this.format_block("jstpl_player_ressource",r),"first-flex-container-"+a,"first");this.addTooltipHtml("action_p"+a,this.format_block("jstpl_tooltip_classic",{title:this.translatableTexts.secondActionTooltipTitle}));if(this.gamedatas.counters["ancientshardcount_p"+a]){var p={id:a};e.place(this.format_block("jstpl_ancient_shard",p),"ressources_container_p"+a,"last")}e.place(this.format_block("jstpl_hammer",r),"ressources_container_p"+a,"last");if(this.gamedatas.counters["hammercount_p"+a]){e.query("#hammercount_p"+a)[0].innerHTML=this.gamedatas.counters["hammercount_p"+a];e.query("#hammers_p"+a)[0].innerHTML=r.nbHammer;e.removeClass("hammer_container_p"+a,"hide");1&~~(this.gamedatas.players[a].hammer_position/15)?e.addClass("hammer_p"+a,"ressources-hammer2"):e.addClass("hammer_p"+a,"ressources-hammer1");r.remainingHammer>1&&e.removeClass("hammersleft_p"+a,"hide")}merchant=0;for(var u in this.gamedatas.exploits["pile3-"+a])if("recurrent"==this.gamedatas.exploitTypes[this.gamedatas.exploits["pile3-"+a][u].type].actionType){var m=this.gamedatas.exploits["pile3-"+a][u].id,f=this.gamedatas.exploits["pile3-"+a][u].type;if("merchant"==f){merchant++;if(merchant>1)continue}e.place(this.format_block("jstpl_power",{id:m,type:f}),"powers_p"+a);this.addPowerToolTip("power-"+m,f)}if(merchant>0){$merchant=document.querySelector("#powers_p"+a+" .power-merchant");$merchant.innerHTML=merchant}for(M=0;M<r.triton;M++){e.place(this.format_block("jstpl_token_id",{size:"small",type:"triton",player_id:a,num:M}),"tokens_p"+a);this.addPowerToolTip("token-triton-"+a+"-"+M,"triton")}for(M=0;M<r.cerberus;M++){e.place(this.format_block("jstpl_token_id",{size:"small",type:"cerberus",player_id:a,num:M}),"tokens_p"+a);this.addPowerToolTip("token-cerberus-"+M,"cerberus")}if(firstPlayerID==a){e.place(this.format_block("jstpl_ressource_id",{id:"first-player-token",size:"small",type:"first"}),"action_p"+a,"before");this.addTooltipHtml("first-player-token",this.format_block("jstpl_tooltip_classic",{title:this.translatableTexts.firstPlayerTooltipTitle}))}"begin"==r.position?e.place(this.format_block("jstpl_player_pawn",{color:this.colors[r.color]}),"position-init-"+this.colors[r.color]):e.place(this.format_block("jstpl_player_pawn",{color:this.colors[r.color]}),"position-"+r.position);this.lastSideUp[a]={};var g=t.playersDice[a],y=g.dice1.map((function(e){return{id:e.id,class:i.sideClass[e.type],type:e.type}}));y.dice=1;y.player_id=a;y.type="fire";var b=g.dice2.map((function(e){return{id:e.id,class:i.sideClass[e.type],type:e.type}}));b.dice=2;b.player_id=a;b.type="moon";this.lastSideUp[a][1]={id:g.dice1[0].id,type:g.dice1[0].type};this.lastSideUp[a][2]={id:g.dice2[0].id,type:g.dice2[0].type};e.place(this.format_block("jstpl_dice",y),"player-"+a+"-dice-3D-1");e.place(this.format_block("jstpl_dice",b),"player-"+a+"-dice-3D-2");e.place(this.format_block("jstpl_dice_flat",y),"player-"+a+"-dice-1");e.place(this.format_block("jstpl_dice_flat",b),"player-"+a+"-dice-2")}for(var C in this.gamedatas.sides){this.pools[C]=new ebg.stock;this.pools[C].create(this,$("pool-"+C),45,45);this.pools[C].image_items_per_row=100;this.pools[C].item_margin=0;this.pools[C].setSelectionMode(0);this.pools[C].setSelectionAppearance("class");this.pools[C].onItemCreate=e.hitch(this,"addSideStuff");for(var S in this.gamedatas.sides[C]){var k=(W=this.gamedatas.sides[C][S]).type,T=this.sidePosition.indexOf(k);this.pools[C].addItemType(T,0,g_gamethemeurl,T);this.pools[C].addToStockWithId(T,W.id,"pool-"+C);this.gamedatas.dice_sides[k].hasOwnProperty("tooltip")&&this.addTooltipHtml("pool-"+C+"_item_"+W.id,this.format_block("jstpl_tooltip_side",{description:this.replaceTextWithIcons(_(this.gamedatas.dice_sides[k].tooltip))}))}}exploitId=0;for(var v in this.exploitSlot){var x=this.exploitSlot[v];this.exploits[x]=new ebg.stock;this.exploits[x].create(this,$("exploit-"+x),this.exploitWidth,this.exploitHeight);this.exploits[x].image_items_per_row=this.exploitByRow;this.exploits[x].setOverlap(.25,.25);this.exploits[x].setSelectionMode(0);this.exploits[x].item_margin=0;this.exploits[x].onItemCreate=e.hitch(this,"addCardStuff");if(this.gamedatas.exploits.hasOwnProperty(x)){var A=Object.keys(this.gamedatas.exploits[x]).length;e.place(this.format_block("jstpl_card_number",{slot:x,nb:A}),"exploit-"+x,"first");for(var M=Object.keys(this.gamedatas.exploits[x]).length-1;M>=0;M--){var w=Object.keys(this.gamedatas.exploits[x])[M],P=this.gamedatas.exploits[x][w];this.exploits[x].addItemType(x,0,g_gamethemeurl+"img/sprite-cards-reb.jpg",2*this.exploitSpritePosition[P.type]);this.exploits[x].addToStockWithId(x,P.id)}}}for(var a in this.gamedatas.players){var F="pile-"+a;this.exploits[F]=new ebg.stock;this.exploits[F].create(this,$(F),this.exploitWidth,this.exploitHeight);this.exploits[F].image_items_per_row=this.exploitByRow;this.exploits[F].setOverlap(.01,.01);this.exploits[F].setSelectionMode(0);this.exploits[F].item_margin=0;this.exploits[F].onItemCreate=e.hitch(this,"addCardStuff");for(var I in this.pileList){exp=this.pileList[I]+"-"+a;for(var E in this.gamedatas.exploitTypes){P=this.gamedatas.exploitTypes[E];this.exploits[F].addItemType(E,0,g_gamethemeurl+"img/sprite-cards-reb.jpg",2*this.exploitSpritePosition[E]+1)}if(-1==this.exploitSlot.indexOf(exp)&&"table"!=exp.substr(0,5))for(var w in this.gamedatas.exploits[exp]){f=(P=this.gamedatas.exploits[exp][w]).type;if(null!=this.classEffect[f]){var z="token-"+a+"-"+P.id;e.place(this.format_block("jstpl_ressource_id",{id:z,size:"small",type:this.classEffect[f]}),"action_p"+a,"before");this.addPowerToolTip(z,f)}this.exploits[F].addToStockWithId(P.type,P.id)}}for(var B in this.gamedatas.exploits["pile2-"+a]){"twins"==(u=this.gamedatas.exploits["pile2-"+a][B]).type&&"1"==u.type_arg&&e.query("#token-"+a+"-"+B).addClass("unusable")}if(t.exploits.hasOwnProperty("table-"+a))for(var D in t.exploits["table-"+a]){u=t.exploits["table-"+a][D];this.exploits["pile-"+a].addToStockWithId(u.type,u.id)}if(this.gamedatas.powerTokens.hasOwnProperty(a))for(var H in this.gamedatas.powerTokens[a]){var O=H.split("_");if("companion"!=O[0]){var q=e.place(e.place(this.format_block("jstpl_token_scepter",{size:"small",type:O[0],player_id:a,num:O[1]}),"tokens_p"+a),"tokens_p"+a);q.classList.add("token-"+O[0]+"-"+this.gamedatas.powerTokens[a][H].state)}else"companion"==O[0]&&this.notifCompanion({args:{card_id:"power-"+O[1],val:this.gamedatas.powerTokens[a][H].state}});this.addPowerToolTip("token-"+O[0]+"-"+a+"-"+O[1],O[0])}}this.exploits.draft=new ebg.stock;this.exploits.draft.create(this,$("draft-stock"),this.exploitWidth,this.exploitHeight);this.exploits.draft.image_items_per_row=this.exploitByRow;this.exploits.draft.setSelectionMode(0);this.exploits.draft.item_margin=5;this.exploits.draft.onItemCreate=e.hitch(this,"addCardStuff");for(var R in this.gamedatas.exploitTypes){cardObject=this.gamedatas.exploitTypes[R];this.exploits.draft.addItemType(R,0,g_gamethemeurl+"img/sprite-cards-reb.jpg",2*this.exploitSpritePosition[R])}e.place(this.format_block("jstpl_turn_count",{title:this.translatableTexts.round,nbTurns:this.gamedatas.nbTurns,turnCount:this.gamedatas.turnCount}),"nb-turns-container");this.turnPlayerId=t.turnPlayerId;if(0!=this.turnPlayerId){e.addClass("overall_player_board_"+t.turnPlayerId,"active");e.addClass("player-container-"+t.turnPlayerId,"active")}1==t.secondActionTaken&&e.removeClass("action_p"+t.turnPlayerId,"hide");if(1==t.remainingTurns){var j=document.getElementById("nb-turns-container");e.addClass(j,"lastTurn");j.innerHTML=this.translatableTexts.lastTurnMessage}this.isSpectator&&e.addClass(e.byId("player-container-"+this.player_id),"hide");this.updateCounters(t.counters);for(M=1;M<=6;M++)this.addTooltipHtml("celestial_side_container_"+M,this.format_block("jstpl_tooltip_title",{title:this.gamedatas.celestialInfo.name,description:this.replaceTextWithIcons(_(this.gamedatas.celestialInfo.description))}));if(this.gamedatas.rebellion<3){e.addClass("rebellion-pools","hide");e.addClass("maze-board","hide");e.addClass("titan-board","hide");this.gamedatas.hasCelestial||e.addClass("celestial_dice","hide")}else if(3==this.gamedatas.rebellion){e.addClass("maze-board","hide");this.gamedatas.hasCelestial||e.addClass("celestial_dice","hide");for(var L in this.gamedatas.titanPassives){var G=this.gamedatas.titanPassives[L];q=document.querySelector('[data-ref="'+L+'"]');this.addTooltipHtml(q.id,this.format_block("jstpl_tooltip_side",{description:this.ressourcesTextToIcon(_(G.description))}))}for(var a in this.gamedatas.players){w=this.gamedatas.zones["position_"+a].state;e.place(this.format_block("jstpl_titan_player",{color:this.colors[this.gamedatas.players[a].color]}),"titan-tile-"+w)}for(var U in this.gamedatas.memoryTokens){if("none"==this.gamedatas.memoryTokens[U].location||"used"==this.gamedatas.memoryTokens[U].location)continue;var V,N=U.split("_"),W="";let t="";if("1"==this.gamedatas.memoryTokens[U].state){W="sun";t="2 [L] 1 [FS]"}else{W="moon";t="2 [AS] 1 [MS]"}e.place(this.format_block("jstpl_memory_id",{id:U,type:this.memoryMap[N[0]]+W}),"memory-"+this.gamedatas.memoryTokens[U].location);V='<span style="font-weight:bold;color:#'+this.gamedatas.players[N[2]].color+'">'+this.gamedatas.players[N[2]].name+"</span>";this.addTooltipHtml(U,this.format_block("jstpl_tooltip_title",{title:_("Memory token of ")+V,description:_("Gain ")+this.ressourcesTextToIcon(t)}))}}else if(4==this.gamedatas.rebellion){e.addClass("titan-board","hide");for(M=1;M<=36;M++)null!==this.gamedatas.maze[M].reward&&""!=this.gamedatas.maze[M].description&&this.addTooltipHtml("maze-tile-"+M,this.format_block("jstpl_tooltip_maze",{description:this.ressourcesTextToIcon(_(this.gamedatas.maze[M].description)),icon:this.format_block("jstpl_maze_element",{size:"big",type:this.mazeClass["m"+this.gamedatas.maze[M].reward]})}));this.addTooltipHtml("maze-first-finish",this.format_block("jstpl_tooltip_maze",{description:this.ressourcesTextToIcon(_(this.gamedatas.maze.firstFinish.description)),icon:this.format_block("jstpl_maze_element",{size:"big",type:this.mazeClass["m"+this.gamedatas.maze.firstFinish.reward]})}));for(var a in this.gamedatas.players){w=this.gamedatas.zones["position_"+a].state;e.place(this.format_block("jstpl_golem",{color:this.colors[this.gamedatas.players[a].color]}),"maze-tile-"+w);var Y=this.format_block("jstpl_token",{size:"small",type:this.colors[this.gamedatas.players[a].color]+"-golem"});e.place(this.format_block("jstpl_player_maze_info",{golem:Y,color:this.colors[this.gamedatas.players[a].color],name:this.gamedatas.players[a].name}),"maze-caption")}for(var Z in this.gamedatas.treasures)if("none"!=this.gamedatas.treasures[Z].location){var Q=Z.split("_");this.addTreasureToolTip(this.gamedatas.treasures[Z].location,Q[1])}}var J=document.getElementById("maze-board");"true"==(null==this.getMyCookie("dfMazePulse")?"true":this.getMyCookie("dfMazePulse"))&&J.classList.add("pulse");this.connexions.mazePulse=e.connect(J,"onclick",this,"onClickMazePulse");this.gamedatas.hasOwnProperty("celestial")&&this.rollCelestialDice(t.celestial,!1);this.activateTritonToken();let K=t.turnPlayerId;0!=K&&this.notifUseScepter({args:{player_id:K,fireshard:t.convertedScepter.fire,moonshard:t.convertedScepter.moon}});this.setupNotifications()},onClickShowDiscard:function(t){e.stopEvent(t);$overlay=document.querySelector(".fixed-center");$overlay.classList.toggle("show");$myDiscard=document.querySelector(".current-player-play-area .cards-pile");$overlay.innerHTML=$myDiscard.innerHTML;$overlay.querySelectorAll(".exploit").forEach((function(e){e.removeAttribute("id")}));$overlay.querySelectorAll(".card-counter").forEach((function(e){e.removeAttribute("id")}))},onClickHideDiscard:function(t){e.stopEvent(t);$overlay=document.querySelector(".fixed-center");$overlay.innerHTML="";$overlay.classList.remove("show")},onEnteringState:function(t,i){switch(t){case"draft":e.query(".container-play-area").addClass("hide");e.query("#draft-container").removeClass("hide");i.args.slot;for(var s in i.args.exploits){var o=i.args.exploits[s];this.exploits.draft.addToStockWithId(o.type,o.type)}this.isCurrentPlayerActive()&&this.exploits.draft.setSelectionMode(1);break;case"endPlayerTurn":(el=e.query(".ressources-2nd-action:not(.hide)")[0])&&e.addClass(el,"hide");break;case"tritonToken":this.prepareChoiceState(i,"actUseTritonToken");break;case"exploitRessource":this.playedAction=i.args.card.action;if((this.isCurrentPlayerActive()||i.active_player==this.player_id)&&i.args.hasOwnProperty(this.player_id)&&"side"==i.args[this.player_id].action)if(i.args[this.player_id].firstFinish){$("pagemaintitletext").innerHTML=this.translatableTexts.celestialChooseSides;this.selfSides.activate("OneSidePerDice","onClickConfirmGoddessCard")}else{if(""!=i.args.celestial||i.args[this.player_id].side_choice.side98){this.prepareChoiceState({args:i.args},i.args[this.player_id].action);break}switch(this.playedAction){case"steal2":$("pagemaintitletext").innerHTML=this.translatableTexts.satyrsDescriptionMyTurn;var a=[];nbMirror=0;this.clientStateArgs.side_choice={side1:!0,side2:!0};for(var r in this.gamedatas.players)if(r!=this.player_id)for(var n=1;n<=2;n++){var l="mirror"==this.lastSideUp[r][n].type;a.push({player_id:r,dice:n,is_mirror:l});l&&nbMirror++}if(nbMirror)for(n=1;n<=2;n++){l="mirror"==this.lastSideUp[this.player_id][n].type;a.push({player_id:this.player_id,dice:n,is_mirror:l})}i={title:this.translatableTexts.satyrsDescriptionMyTurn,selectMode:"sides",nbToSelect:2,sameSelectable:nbMirror>=2,limitSelfSelect:1==nbMirror,canCancel:!1,dices:a,action:"onClickSideChoiceConfirm",hideMirror:!0};this.initDiceSelection(i);break;case"chooseSides":if(0==i.args[this.player_id].mirror){$("pagemaintitletext").innerHTML=this.translatableTexts.celestialChooseSides;this.selfSides.activate("OneSidePerDice","onClickConfirmGoddessCard")}break;case"throwCelestialDie":switch(i.args.celestial){case"celestialMirror":this.clientStateArgs.side_choice={side1:!0,side2:!1};a=[];for(var r in this.gamedatas.players)for(n=1;n<=2;n++)a.push({player_id:r,dice:n,is_mirror:"mirror"==this.lastSideUp[r][n].type});i={title:this.translatableTexts.celestialMirror,selectMode:"sides",nbToSelect:1,mirrorVisible:!1,dices:a,canCancel:0,action:"onClickSideChoiceConfirm",hideMirror:!0};this.initDiceSelection(i);break;case"chooseSide":$("pagemaintitletext").innerHTML=this.translatableTexts.celestialChooseSide;this.selfSides.activate("OneSide","onClickConfirmCelestialMirror")}}}this.isCurrentPlayerActive()&&"looseThrow"==this.playedAction&&i.args.hasOwnProperty(this.player_id)&&"cerberusToken"!=i.args[this.player_id].action&&(!i.args[this.player_id].sides.hasOwnProperty("0")||parseInt(i.args[this.player_id].sides[0].num)<=2)&&($("pagemaintitletext").innerHTML=this.translatableTexts.minotaurDescriptionMyTurn);break;case"reinforcement":this.isCurrentPlayerActive()&&(null!=this.statesInfo[t]&&i==this.statesInfo[t]||(this.statesInfo[t]=this.duplicateObject(i)));this.activateReinforcement(i.args);break;case"playerAction":if(this.isCurrentPlayerActive()){if(1==this.prefs[100].value){null==this.statesInfo[t]&&(this.statesInfo[t]=this.duplicateObject(i));if(i.args.isForging){i.args.descriptionmyturn=this.translatableTexts.isForgingDescriptionMyTurn;this.gotoChooseForge(i.args)}else this.enablePlayerActionHelp()}else if(2==this.prefs[100].value)if(i.args.isForging){$("pagemaintitletext").innerHTML=this.translatableTexts.isForgingDescriptionMyTurn;this.selectForge.init({isForging:!0})}else{this.selectForge.init();this.activateExploits()}this.activateSpecificCards(i.args.companion)}break;case"chooseForge":var c=!(!i.args.hasOwnProperty("isForging")||!i.args.isForging);this.selectForge.init({isForging:c});break;case"chooseExploit":i.slots?this.activateExploits(i.slots):this.activateExploits(null);if(i.free){this.clientStateArgs.free=!0;this.removeActionButtons()}break;case"exploitEffect":null==this.statesInfo[t]&&(this.statesInfo[t]=this.duplicateObject(i));if(i.args.hasOwnProperty("card")){this.playedAction=i.args.card.action;if(!i.args.effectRunning){$("pagemaintitletext").innerHTML=i.args.info.player+" "+this.replaceTextWithIcons(_(i.args.info.power_desc));(this.isCurrentPlayerActive()||i.active_player==this.player_id)&&($("pagemaintitletext").innerHTML=this.divYou()+" "+this.replaceTextWithIcons(_(i.args.info.power_you)))}switch(this.playedAction){case"4Throws":case"4ThrowsTransform":if((this.isCurrentPlayerActive()||i.active_player==this.player_id)&&!i.args.effectRunning){$("pagemaintitletext").innerHTML=this.translatableTexts.sphinxDescriptionMyTurn;i={title:this.translatableTexts.sphinxDescriptionMyTurn,selectMode:"flat",nbToSelect:1,canCancel:0,action:"onDiceSelection4Throws",dices:[{player_id:this.player_id,dice:1},{player_id:this.player_id,dice:2}],hideMirror:!0};this.initDiceSelection(i)}break;case"side3x":var d=e.query("#pool-15 .bside").length?e.query("#pool-15 .bside")[0].id.match(/pool-15_item_([0-9]+)/)[1]:0;params={sideToForge:d,forgeType:"triple"};this.isCurrentPlayerActive()&&d&&this.selectForge.init(params);break;case"sideShip":d=e.query("#pool-13 .bside").length?e.query("#pool-13 .bside")[0].id.match(/pool-13_item_([0-9]+)/)[1]:0;params={sideToForge:d,forgeType:"ship"};this.isCurrentPlayerActive()&&d&&this.selectForge.init(params);break;case"shieldForge":params={forgeType:"shield"};this.isCurrentPlayerActive()&&this.selectForge.init(params);break;case"sideMirror":d=e.query("#pool-11 .bside").length?e.query("#pool-11 .bside")[0].id.match(/pool-11_item_([0-9]+)/)[1]:0;params={sideToForge:d,forgeType:"mirror"};this.isCurrentPlayerActive()&&d&&this.selectForge.init(params);break;case"boarForge":case"sideMisfortune":if(this.isCurrentPlayerActive())for(var r in this.gamedatas.players)r!=this.player_id&&this.addActionButton("boar_player_"+r,'<span style="font-weight:bold;color:#'+this.gamedatas.players[r].color+'">'+this.gamedatas.players[r].name+"</span>","onClickBoarPlayer",null,null,"gray");break;case"forge4G":params={forgeType:"gold"};this.isCurrentPlayerActive()&&this.selectForge.init(params);break;case"forgeVP":if(null!=i.args.poolToForge&&-1!=i.args.poolToForge){param={forgeType:"select",poolList:[i.args.poolToForge]};this.isCurrentPlayerActive()&&this.selectForge.init(param)}else if(this.isCurrentPlayerActive()&&null==i.args.poolToForge){i={title:this.translatableTexts.ancestorNoSide,selectMode:"flat",nbToSelect:1,dices:[{player_id:this.player_id,dice:1},{player_id:this.player_id,dice:2}],action:"onDiceSelectionAncestor"};this.initDiceSelection(i)}break;case"forgeEverywhere":params={forgeType:"select",poolList:i.args.poolList};this.isCurrentPlayerActive()&&this.selectForge.init(params);break;case"freeExploit":this.gotoChooseExploit({slots:["M1","M2","F1","F2"],free:!0});break;case"throwCelestialDie":if("doubleUpgrade"!=i.args.celestial)return;this.clientStateArgs.merchantNbUpgrade=2;this.clientStateArgs.callback="onClickCelestialUpgrade";this.clientStateArgs.canCancel=!1;this.clientStateArgs.celestCancel=!0;this.setClientState("merchantSecondStep",{descriptionmyturn:this.translatableTexts.merchantSecondStep});break;case"sideMoonGolem":d=e.query("#pool-19 .bside").length?e.query("#pool-19 .bside")[0].id.match(/pool-19_item_([0-9]+)/)[1]:0;params={sideToForge:d,forgeType:"moonGolem"};this.isCurrentPlayerActive()&&d&&this.selectForge.init(params);break;case"sideSunGolem":d=e.query("#pool-17 .bside").length?e.query("#pool-17 .bside")[0].id.match(/pool-17_item_([0-9]+)/)[1]:0;params={sideToForge:d,forgeType:"sunGolem"};this.isCurrentPlayerActive()&&d&&this.selectForge.init(params);break;case"sideDogged":params={forgeType:"dogged"};this.isCurrentPlayerActive()&&this.selectForge.init(params);break;case"sideShieldRebellion":params={forgeType:"shieldRebellion"};this.isCurrentPlayerActive()&&this.selectForge.init(params);break;case"memoryTokens":2==Object.keys(i.args.memory).length?$("pagemaintitletext").innerHTML=$("pagemaintitletext").innerHTML+" 1/2":$("pagemaintitletext").innerHTML=$("pagemaintitletext").innerHTML+" 2/2"}}break;case"exploitForgeBoar":params={sideToForge:i.args.id,forgeType:i.args.type};this.isCurrentPlayerActive()&&this.selectForge.init(params);break;case"chooseRessource":this.prepareRessourceSelector();break;case"endScoring":this.prepareEndGame();break;case"gameEnd":this.prepareEndGame();for(var r in this.gamedatas.players){var h="pile-"+r,p=this.exploits[h].getAllItems();for(var s in p){item=p[s];var u="final-card-p"+r;this.exploits[u].addToStockWithId(item.type,item.id,h+"_item_"+item.id);this.exploits[h].removeFromStockById(item.id)}}break;case"secondAction":$("pagemaintitletext").innerHTML=this.ressourcesTextToIcon($("pagemaintitletext").innerHTML);this.activateSpecificCards(i.args.companion);break;case"forgeShip":case"oustedForgeShip":case"doeForgeShip":case"exploitForgeShip":params={};if(this.isCurrentPlayerActive())if("doubleUpgrade"==i.args.ship){this.clientStateArgs.merchantNbUpgrade=2;this.clientStateArgs.callback="onClickCelestialUpgrade";this.clientStateArgs.canCancel=!1;this.clientStateArgs.celestCancel=!0;this.setClientState("merchantSecondStep",{descriptionmyturn:this.translatableTexts.merchantSecondStep})}else this.selectForge.init(params);break;case"scepterUse":break;case"merchantSecondStep":var m=this;e.query(".current-player-play-area .dice-flat .bside").addClass("clickable");m.connexions.forge=e.query(".current-player-play-area .bside").map((function(t){return e.connect(t,"onclick",m,"onClickMerchantThirdStep")}));break;case"memoryIsland":m=this;e.query(".position:not(#position-init-blue):not(#position-init-green):not(#position-init-black):not(#position-init-orange)").addClass("clickable");m.connexions.islands=e.query(".position:not(#position-init-blue):not(#position-init-green):not(#position-init-black):not(#position-init-orange)").map((function(t){return e.connect(t,"onclick",m,"onClickMemorySetup")}))}},onLeavingState:function(t){switch(t){case"draft":this.exploits.draft.removeAll();this.exploits.draft.setSelectionMode(0);break;case"reinforcement":this.deactivateReinforcement();this.statesInfo={};break;case"playerAction":this.disablePlayerActionHelp();this.deactivateReinforcement();if(2==this.prefs[100].value){this.selectForge.end();this.deactivateExploits()}break;case"secondAction":this.deactivateReinforcement();break;case"chooseForge":case"forgeShip":this.selectForge.end();break;case"chooseExploit":this.deactivateExploits();break;case"forgeDice":this.hideSidesToForge();e.query(".dices-container").removeClass("flat");e.query(".forge").addClass("hidden");break;case"exploitEffect":if(this.connexions.hasOwnProperty("die1")){e.disconnect(this.connexions.die1);delete this.connexions.die1}if(this.connexions.hasOwnProperty("die2")){e.disconnect(this.connexions.die2);delete this.connexions.die2}this.selectForge.end();e.query(".dices-container").removeClass("flat");break;case"exploitRessource":case"ressourceChoice":case"playerOustingChoice":case"doeRessourceChoice":case"misfortuneChoice":case"tritonToken":this.cleanClientStateArgs();this.statesInfo={};break;case"dummmy":break;case"merchantSecondStep":e.query(".current-player-play-area .bside").removeClass("selected");e.query(".current-player-play-area .bside").removeClass("clickable");if(this.connexions.hasOwnProperty("forge")){e.forEach(this.connexions.forge,(function(t){e.disconnect(t)}));delete this.connexions.forge}this.selectForge.deactivatePoolSides();break;case"memoryIsland":e.query(".position").removeClass("clickable");if(this.connexions.hasOwnProperty("islands")){e.forEach(this.connexions.islands,(function(t){e.disconnect(t)}));delete this.connexions.islands}}},onUpdateActionButtons:function(t,i){$("pagemaintitletext").innerHTML=this.replaceTextWithIcons($("pagemaintitletext").innerHTML);if(this.isCurrentPlayerActive())switch(t){case"draft":this.addActionButton("confirm_draft_button",this.translatableTexts.confirm,"onClickDraftButton");break;case"reinforcement":this.addActionButton("pass_reinforcement_button",this.translatableTexts.pass,"onClickReinforcementPrePass");break;case"playerAction":if(1==this.prefs[100].value){this.addActionButton("player_action_button_forge",_("Forge"),"onClickPlayerAction");this.addActionButton("player_action_button_exploit",_("Heroic Feat"),"onClickPlayerAction");this.addActionButton("player_action_button_end",this.translatableTexts.endTurnButton,"onClickPlayerAction",null,null,"red")}else 2==this.prefs[100].value&&(i.isForging?this.addActionButton("forge_action_button_end",this.translatableTexts.endForgeButton,"onClickEndForge",null,null,"red"):this.addActionButton("player_action_button_end",this.translatableTexts.endTurnButton,"onClickPlayerAction",null,null,"red"));0!=i.scepters&&this.addActionButton("player_action_cancel_scepters",this.translatableTexts.cancelScepters,"onClickCancelScepter",null,null,"red");break;case"forgeShip":case"oustedForgeShip":case"doeForgeShip":case"exploitForgeShip":"mForge"==i.ship&&($("pagemaintitletext").innerHTML=this.replaceTextWithIcons(this.translatableTexts.mazeClassicalForge));i[this.player_id].hasOwnProperty("sides")?toUse=i[this.player_id].sides[0].num:toUse="123456";this.addActionButton("forge_ship_pass_"+toUse,this.translatableTexts.pass,"onClickForgeShipPass",null,null,"red");break;case"merchantFirstStep":for(var s in this.pools)this.pools[s].unselectAll();for(var o=_("upgrade(s)"),a=0;a<=this.clientStateArgs.merchantNbUpgrade;a++){h=this.clientStateArgs.merchantNbUpgrade-a;merchantText=0==a?this.replaceTextWithIcons(2*parseInt(h)+"[VP]"):0==h?this.replaceTextWithIcons(a+" "+o):this.replaceTextWithIcons(a+" "+o+" "+2*parseInt(h)+"[VP]");this.addActionButton("merchant"+a+"_"+a+"_"+h,merchantText,"onClickMerchantStepOne",null,null,"gray")}this.addActionButton("merchantCancel",this.translatableTexts.cancel,"restoreServerGameState",null,null,"red");break;case"merchantSecondStep":!this.clientStateArgs.hasOwnProperty("canCancel")||this.clientStateArgs.canCancel?this.addActionButton("merchantCancel",this.translatableTexts.cancel,"restoreServerGameState",null,null,"red"):this.clientStateArgs.hasOwnProperty("celestCancel")&&!0===this.clientStateArgs.celestCancel&&this.addActionButton("merchantCancel",this.translatableTexts.cancel,"onClickCancelCelestial",null,null,"red");break;case"chooseForge":i.isForging?this.addActionButton("forge_action_button_end",this.translatableTexts.endForgeButton,"onClickEndForge",null,null,"red"):this.addActionButton("forge_action_button_cancel",this.translatableTexts.cancel,"onClickCancelForge",null,null,"red");break;case"chooseExploit":this.addActionButton("exploit_action_button_cancel",this.translatableTexts.cancel,"onClickCancelPlayerAction",null,null,"red");break;case"secondAction":var r=this.getPlayerRessources(),n=[],l=2;let t=[];for(a=0;a<=l;a++){let e=a+" [FS] "+(l-a)+" [AS]";t.push([a,0,l-a,e])}n=t.filter((e=>e[0]<=r.fireshard&&e[2]<=r.ancientshard));n=(n=this.generateButtonText(n)).sort((function(e,t){return e[0]==t[0]?e[1]==t[1]?t[2]-e[2]:t[1]-e[1]:t[0]-e[0]}));let p=0;for(let e in n){this.addActionButton("secondAction"+p+"_"+n[e][0]+"_"+n[e][1]+"_"+n[e][2],this.replaceTextWithIcons(n[e][4]),"onClickSecondActionPlay",null,null,"gray");p++}this.addActionButton("secondAction_0_0_0",this.translatableTexts.no,"onClickSecondActionPass",null,null,"gray");0!=i.scepters&&this.addActionButton("player_action_cancel_scepters",this.translatableTexts.cancelScepters,"onClickCancelScepter",null,null,"red");break;case"owlChoose":this.addActionButton("owlGold",this.format_block("jstpl_ressource",{size:"small",type:"gold"}),"onClickOwlGold",null,null,"gray");this.hasHammer(this.player_id)&&this.addActionButton("owlHammer",this.format_block("jstpl_ressource",{size:"small",type:"hammer"}),"onClickOwlHammer",null,null,"gray");this.addActionButton("owlFireshard",this.format_block("jstpl_ressource",{size:"small",type:"fire"}),"onClickOwlFireshard",null,null,"gray");this.addActionButton("owlMoonshard",this.format_block("jstpl_ressource",{size:"small",type:"moon"}),"onClickOwlMoonshard",null,null,"gray");this.addActionButton("ownCancel",this.translatableTexts.cancel,"restoreServerGameState",null,null,"red");break;case"guardianChoose":this.addActionButton("guardianAncient",this.format_block("jstpl_ressource",{size:"small",type:"ancient-shard"}),"onClickGuardianAncient",null,null,"gray");this.addActionButton("guardianLoyalty",this.format_block("jstpl_ressource",{size:"small",type:"loyalty"}),"onClickGuardianLoyalty",null,null,"gray");this.addActionButton("ownCancel",this.translatableTexts.cancel,"restoreServerGameState",null,null,"red");break;case"ressourceChoice":var c="actRessourceChoice";this.preActionChoice(i,c);break;case"playerOustingChoice":c="actOustedRessources";this.preActionChoice(i,c);break;case"doeRessourceChoice":c="actDoeTakeRessource";this.preActionChoice(i,c);break;case"misfortuneChoice":c="actMisfortuneChoice";this.preActionChoice(i,c);break;case"exploitRessource":c="";i.hasOwnProperty(this.player_id)&&"side"==i[this.player_id].action?"steal2"!=i.card.action&&"throwCelestialDie"!=i.card.action&&("chooseSides"!=i.card.action||"chooseSides"==i.card.action&&0!=i[this.player_id].mirror)&&(c="actExploitRessource"):i.hasOwnProperty(this.player_id)&&(c="actExploitRessource");this.preActionChoice(i,c);break;case"tritonToken":this.addActionButton("tokenCancel",this.translatableTexts.cancel,"cancelLocalStateEffects",null,null,"red");break;case"exploitEffect":if(i.hasOwnProperty("card"))switch(i.card.action){case"side3x":this.addActionButton("help_button_side3x",this.translatableTexts.question,"onClickHelpForgeButton",null,null,"gray");break;case"sideShip":this.addActionButton("help_button_sideShip",this.translatableTexts.question,"onClickHelpForgeButton",null,null,"gray");break;case"sideMirror":this.addActionButton("help_button_sideMirror",this.translatableTexts.question,"onClickHelpForgeButton",null,null,"gray");break;case"shieldForge":this.addActionButton("help_button_shieldForge",this.translatableTexts.question,"onClickHelpForgeButton",null,null,"gray");break;case"forge4G":this.addActionButton("forge_ship_pass_11",this.translatableTexts.pass,"onClickForgeNymphPass",null,null,"red");break;case"memoryTokens":console.debug(i.memory);this.clientStateArgs.memory=Object.values(i.memory)[0];this.addActionButton("memorySun",this.replaceTextWithIcons("2 [L] 1 [FS]"),"onClickMemoryChoose",null,null,"gray");this.addActionButton("memoryMoon",this.replaceTextWithIcons("2 [AS] 1 [MS]"),"onClickMemoryChoose",null,null,"gray")}break;case"exploitForgeBoar":this.addActionButton("help_button_boarForge",this.translatableTexts.question,"onClickHelpForgeButton",null,null,"gray");break;case"useScepter":this.clientStateArgs.actionData;this.addActionButton("scepterFireshard",this.replaceTextWithIcons(this.clientStateArgs.actionData.amount+" [FS]"),"onClickScepterFireshard",null,null,"gray");this.addActionButton("scepterMoonshard",this.replaceTextWithIcons(this.clientStateArgs.actionData.amount+" [MS]"),"onClickScepterMoonshard",null,null,"gray");this.addActionButton("scepterCancel",this.translatableTexts.cancel,"restoreServerGameState",null,null,"red");break;case"buyWithAncientshard":r=this.getPlayerRessources(),l=parseInt(e.byId("exploit-"+this.clientStateArgs.actionData.slot+"_item_"+this.clientStateArgs.actionData.card_id).parentElement.getAttribute("data-costfire"));var d=parseInt(e.byId("exploit-"+this.clientStateArgs.actionData.slot+"_item_"+this.clientStateArgs.actionData.card_id).parentElement.getAttribute("data-costmoon"));if(r.fireshard+r.ancientshard<l||r.moonshard+r.ancientshard<d||0!=d&&0!=l&&r.moonshard+r.fireshard+r.ancientshard<d+l){this.showMessage(this.translatableTexts.notEnoughResource,"error");this.cancelLocalStateAndClean();return}n=[];if(0!=l&&0==d){let e=[];for(a=0;a<=l;a++){let t=a+" [FS] "+(l-a)+" [AS]";e.push([a,0,l-a,t])}n=e.filter((e=>e[0]<=r.fireshard&&e[2]<=r.ancientshard))}else if(0==l&&0!=d){let e=[];for(a=0;a<=d;a++)e.push([0,a,d-a]);n=e.filter((e=>e[1]<=r.moonshard&&e[2]<=r.ancientshard))}else{let e=[];for(a=0;a<=l;a++)for(var h=0;h<=d;h++)e.push([a,h,l+d-a-h]);n=e.filter((e=>e[0]<=r.fireshard&&e[1]<=r.moonshard&&e[2]<=r.ancientshard))}if(1==n.length)this.onClickBuyExploitWithAncient({target:{id:"exploitChoice_"+n[0][0]+"_"+n[0][1]+"_"+n[0][2]}});else{n=(n=this.generateButtonText(n)).sort((function(e,t){return e[0]==t[0]?e[1]==t[1]?t[2]-e[2]:t[1]-e[1]:t[0]-e[0]}));let e=0;for(let t in n){this.addActionButton("exploitChoice"+e+"_"+n[t][0]+"_"+n[t][1]+"_"+n[t][2],this.replaceTextWithIcons(n[t][4]),"onClickBuyExploitWithAncient",null,null,"gray");e++}}this.addActionButton("tokenCancel",this.translatableTexts.cancel,"cancelLocalStateAndClean",null,null,"red");break;case"memoryIsland":this.addActionButton("tokenCancel",this.translatableTexts.cancel,"cancelLocalStateAndClean",null,null,"red")}},generateButtonText:function(e){for(let t in e){let i="";0!=e[t][0]&&(i+=e[t][0]+" [FS] ");0!=e[t][1]&&(i+=e[t][1]+" [MS] ");0!=e[t][2]&&(i+=e[t][2]+" [AS] ");e[t][4]=i}return e},getPlayerRessources:function(){let t={fireshard:0,moonshard:0,ancientshard:0};e.byId("ancientshardcount_p"+this.player_id)&&(t.ancientshard=parseInt(e.byId("ancientshardcount_p"+this.player_id).innerHTML));t.fireshard=parseInt(e.byId("firecount_p"+this.player_id).innerHTML);t.moonshard=parseInt(e.byId("mooncount_p"+this.player_id).innerHTML);""!=e.byId("scepter_fire_"+this.player_id).innerHTML&&(t.fireshard+=parseInt(e.byId("scepter_fire_"+this.player_id).innerHTML.substring(1,3)));""!=e.byId("scepter_moon_"+this.player_id).innerHTML&&(t.moonshard+=parseInt(e.byId("scepter_moon_"+this.player_id).innerHTML.substring(1,3)));return t},format_string_recursive:function(e,t){try{if(e&&t&&!t.processed){t.processed=!0;this.isSpectator||(t.You=this.divYou());var i=["ressources","side_type","old_side_type","sides_types","sides_rolled","gold","vp","moonshard","fireshard","ancientshard","loyalty"];for(var s in i){var o=i[s];if("string"==typeof t[o]){var a=this.getIcons(o,t);a&&(t[o]=a)}}t.hasOwnProperty("ousted_player_name")&&(t.ousted_player_name='<span style="font-weight:bold;color:#'+t.ousted_player+'">'+t.ousted_player_name+"</span>")}}catch(i){console.error(e,t,"Exception thrown",i.stack)}return this.inherited(arguments)},getIcons:function(e,t){switch(e){case"ressources":case"gold":case"vp":case"moonshard":case"fireshard":case"ancientshard":case"loyalty":t[e]=this.ressourcesTextToIcon(t[e]);t[e]=this.tokensTextToIcon(t[e]);break;case"old_side_type":case"side_type":t[e]=this.getSideIcon(t[e]);break;case"sides_types":var i=t[e].split(", ");for(var s in i){var o=i[s];i[s]=this.getSideIcon(o)}t[e]=i.join(", ");break;case"sides_rolled":i=t[e].split(",");for(var s in i){o=i[s];i[s]=this.getSideIcon(o)}t[e]=i.join(" ")}return t[e]},escapeRegExp:function(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")},ressourcesTextToIcon:function(e){return this.dataToIcon({"[G]":"gold","[FS]":"fire","[MS]":"moon","[H]":"hammer","[VP]":"vp","[AS]":"ancient-shard","[L]":"loyalty","[M]":"maze","[instant]":"type-instant","[hourglass]":"type-hourglass","[reinforcement]":"type-cog","[2players]":"2p","[3players]":"3p","[4players]":"4p"},"jstpl_ressource",e)},tokensTextToIcon:function(e){return this.dataToIcon({"[S]":"scepter"},"jstpl_token",e)},dataToIcon:function(e,t,i){for(var s in e)i=i.replace(new RegExp(this.escapeRegExp(s),"g"),this.format_block(t,{size:"icon",type:e[s]}));return i},sidesTextToIcon:function(e){for(var t in this.sideClass)e=e.replace(new RegExp(this.escapeRegExp("["+t+"]"),"g"),this.getSideIcon(t));return e},getSideIcon:function(e){return this.format_block("jstpl_bside_icon",{class:this.sideClass[e]+" bside-icon",type:e})},mazeTextToIcon:function(e){for(var t in this.mazeClass)e=e.replace(new RegExp(this.escapeRegExp("["+t+"]"),"g"),this.getMazeIcon(t));return e},getMazeIcon:function(e){return this.format_block("jstpl_maze_icon",{class:this.mazeClass[e]+" maze-small",type:e})},addSideStuff:function(t,i,s){e.addClass(e.byId(s),"bside "+this.sideClass[this.sidePosition[i]])},addCardStuff:function(e,t,i){this.addCardClass(e,t,i);this.addCardTooltip(e,t,i)},addCardClass:function(t,i,s){e.addClass(e.byId(s),"exploit")},addCardTooltip:function(e,t,i){if(-1!=i.lastIndexOf("draft"))var s=i.substr(i.lastIndexOf("_")+1),o=this.exploitTypes[s];else if(-1!=i.lastIndexOf("pile-"))o=this.exploitTypes[t];else{s=i.substr(i.lastIndexOf("_")+1);var a=this.gamedatas.exploits[t][s];o=this.exploitTypes[a.type]}this.addTooltipHtml(e.id,this.getCardTooltip(o))},addPowerToolTip:function(e,t){this.addTooltipHtml(e,this.format_block("jstpl_tooltip_title",{description:this.replaceTextWithIcons(_(this.exploitTypes[t].power_description)),title:_(this.exploitTypes[t].name)}))},addTreasureToolTip:function(t,i){var s="maze-"+i;e.removeClass("maze-reward-"+t,"hide");e.addClass("maze-reward-"+t,"token-"+s);switch(i){case"vp":disp="2 [VP]";break;case"fireshard":disp="1 [FS]";break;case"moonshard":disp="1 [MS]"}this.removeTooltip("maze-tile-"+t);this.addTooltipHtml("maze-tile-"+t,this.format_block("jstpl_tooltip_maze",{description:this.ressourcesTextToIcon(_("Gain ")+disp),icon:this.format_block("jstpl_token",{size:"small",type:s})}))},getCardTooltip:function(e){var t="";e.costMoon&&(t+=e.costMoon+" [MS] ");e.costFire&&(t+=e.costFire+" [FS] ");var i=e.VP+" [VP] ";return this.format_block("jstpl_tooltip_card",{title:_(e.name),cost:this.translatableTexts.tooltipCardCost+this.replaceTextWithIcons(t),vp:this.translatableTexts.tooltipCardVP+this.replaceTextWithIcons(i),description:this.replaceTextWithIcons(_(e.description))})},replaceTextWithIcons:function(e){e=this.ressourcesTextToIcon(e);e=this.tokensTextToIcon(e);e=this.sidesTextToIcon(e);return e=this.mazeTextToIcon(e)},enablePlayerActionHelp:function(){var t=this;this.connexions["player-help"]=e.query(".pools .bside, #board .exploit").map((function(i){return e.connect(i,"onclick",t,"onClickShowHelpAction")}))},disablePlayerActionHelp:function(){if(this.connexions.hasOwnProperty("player-help")){e.forEach(this.connexions["player-help"],(function(t){e.disconnect(t)}));delete this.connexions["player-help"]}},onClickShowHelpAction:function(e){this.displayTempOverlay("page-title")},onClickShowDialog:function(e){this.myDlg&&this.myDlg.show()},displayTempOverlay:function(t,i){"[object Array]"!==Object.prototype.toString.call(t)&&(t=[t]);e.place(this.format_block("jstpl_overlay"),"ebd-body","first");(i=null==i?{}:i).durationFadeIn=null==i.durationFadeIn?1e3:i.durationFadeIn;i.durationFadeOut=null==i.durationFadeOut?1e3:i.durationFadeOut;i.delay=null==i.delay?1e3:i.delay;var s={node:"df-overlay",duration:i.durationFadeIn},o={node:"df-overlay",duration:i.durationFadeOut,delay:i.delay};s.onEnd=function(){o.onEnd=function(){e.destroy("df-overlay");for(var i in t)e.query("#"+t[i]).removeClass("above-overlay")};e.fadeOut(o).play()};for(var a in t)e.query("#"+t[a]).addClass("above-overlay");e.fadeIn(s).play()},preActionChoice:function(t,i){if(t.hasOwnProperty(this.player_id)){i&&this.prepareChoiceState({args:t},i);if("actionChoice"==t[this.player_id].action){var s=_("Take");$("pagemaintitletext").innerHTML=this.translatableTexts.shipMultipleActionChoice;if(1==t[this.player_id].twins){if(t[this.player_id].hasOwnProperty("sides")&&t[this.player_id].sides.hasOwnProperty(0)){this.addActionButton("action_getRessource1",s+" "+this.sidesTextToIcon("["+t[this.player_id].sides[0]+"]"),"onClickConfirmActionGetRessource1");this.addActionButton("action_reroll1",this.replaceTextWithIcons(this.translatableTexts.reroll),"onClickConfirmActionReroll1")}if(t[this.player_id].hasOwnProperty("sides")&&t[this.player_id].sides.hasOwnProperty(1)){this.addActionButton("action_getRessource2",s+" "+this.sidesTextToIcon("["+t[this.player_id].sides[1]+"]"),"onClickConfirmActionGetRessource2");this.addActionButton("action_reroll2",this.replaceTextWithIcons(this.translatableTexts.reroll),"onClickConfirmActionReroll2")}if(t[this.player_id].hasOwnProperty("celestialRunning")&&t[this.player_id].celestialRunning){this.addActionButton("action_getCelestialDie",s+" "+this.sidesTextToIcon("["+t[this.player_id].celestialDie+"]"),"onClickConfirmActionGetCelestial");this.addActionButton("action_rerollCelestial",this.replaceTextWithIcons(this.translatableTexts.reroll),"onClickConfirmActionRerollCelestial")}}else if("actMisfortuneChoice"==i){t[this.player_id].sides.hasOwnProperty(0)&&this.addActionButton("action_getRessource1",this.sidesTextToIcon("["+t[this.player_id].sides[0]+"]"),"onClickConfirmActionGetMisfortune1");t[this.player_id].sides.hasOwnProperty(1)&&this.addActionButton("action_getRessource2",this.sidesTextToIcon("["+t[this.player_id].sides[1]+"]"),"onClickConfirmActionGetMisfortune2")}else{t[this.player_id].hasOwnProperty("sides")&&t[this.player_id].sides.hasOwnProperty(0)&&this.addActionButton("action_getRessource1",this.sidesTextToIcon("["+t[this.player_id].sides[0]+"]"),"onClickConfirmActionGetRessource1");t[this.player_id].hasOwnProperty("sides")&&t[this.player_id].sides.hasOwnProperty(1)&&this.addActionButton("action_getRessource2",this.sidesTextToIcon("["+t[this.player_id].sides[1]+"]"),"onClickConfirmActionGetRessource2")}}else if("cerberusToken"==t[this.player_id].action){$("pagemaintitletext").innerHTML=this.translatableTexts.actionUseCerberusToken;this.addActionButton("cerberus_yes",this.translatableTexts.yes,"onClickCerberus");this.addActionButton("cerberus_no",this.translatableTexts.no,"onClickCerberus",null,null,"red")}else if("maze"==t[this.player_id].action){$("pagemaintitletext").innerHTML=this.translatableTexts.mazeChoosePath;for(var o in t[this.player_id].mazePath){if(t[this.player_id].hasOwnProperty("mazeTreasure")&&"treasure"==t[this.player_id].mazePath[o]){var a=t[this.player_id].mazeTreasure[o];this.addActionButton("maze_"+o,this.mazeTextToIcon(a),"onClickConfirmMazePath",null,null,"gray");"[mtreasure]"!=a&&document.getElementById("maze_"+o).querySelector(".maze-small").classList.remove("maze-small")}else this.addActionButton("maze_"+o,this.mazeTextToIcon("[m"+t[this.player_id].mazePath[o]+"]"),"onClickConfirmMazePath",null,null,"gray");var r=document.getElementById("maze_"+o);null!=this.connexions["hovermaze_"+o]&&e.disconnect(this.connexions["hovermaze_"+o]);this.connexions["hovermaze_"+o]=e.connect(r,"onmouseover",this,(function(e){var t=(""==e.target.id?e.target.parentNode:e.target).id.match(/maze_([0-9]+)/)[1];document.getElementById("maze-tile-"+t).classList.add("highlight")}));null==this.connexions["outmaze_"+o]&&e.disconnect(this.connexions["outmaze_"+o]);this.connexions["outmaze_"+o]=e.connect(r,"onmouseout",this,(function(e){var t=(""==e.target.id?e.target.parentNode:e.target).id.match(/maze_([0-9]+)/)[1];document.getElementById("maze-tile-"+t).classList.remove("highlight")}))}}else if("mazeTreasure"==t[this.player_id].action){$("pagemaintitletext").innerHTML=this.translatableTexts.mazeChooseTreasure;for(var n in t[this.player_id].avTreasure){switch(n){case"treasure_fireshard":disp="4 [FS]";break;case"treasure_moonshard":disp="4 [MS]";break;case"treasure_vp":disp="10 [VP]"}this.addActionButton("maze_"+n,this.replaceTextWithIcons(disp),"onClickConfirmMazeTreasure",null,null,"gray")}}else if("mazePuzzle"==t[this.player_id].action){$("pagemaintitletext").innerHTML=this.translatableTexts.shipMultipleActionChoice;this.addActionButton("mazePuzzleMaze",this.ressourcesTextToIcon("[M]"),"onClickConfirmPuzzleMaze",null,null,"gray");this.addActionButton("mazePuzzleCelestial",this.mazeTextToIcon("[mCelestial]"),"onClickConfirmPuzzleCelestial",null,null,"gray")}else if("mazeConfirm"==t[this.player_id].action){$("pagemaintitletext").innerHTML=this.translatableTexts.mazeConfirmReward;this.activateTritonToken(!0);switch(t[this.player_id].reward){case"convert6Gto6VP":this.addActionButton("mazePowerYes",this.ressourcesTextToIcon("-6[G] → 6[VP]"),"onClickConfirmMazePower",null,null,"gray");break;case"convertMS2to8VP":this.addActionButton("mazePowerYes",this.ressourcesTextToIcon("-2[MS] → 8[VP]"),"onClickConfirmMazePower",null,null,"gray")}this.addActionButton("mazeRewardNo",_("Do nothing"),"onClickRejectMazePower",null,null,"red")}}},prepareEndGame:function(){if(!document.getElementsByClassName("final-card-container").length){var t=e.query(".container-play-area")[0];e.addClass(t,"end");e.query(".roll").removeClass("roll");for(var i in this.gamedatas.players){var s=e.query("#player-container-"+i+" .action-row")[0];e.place(this.format_block("jstpl_final_card_container",this.gamedatas.players[i]),s,"after");e.addClass(s,"hide");var o="final-card-p"+i;this.exploits[o]=new ebg.stock;this.exploits[o].create(this,$(o),this.exploitWidth,this.exploitHeight);this.exploits[o].image_items_per_row=this.exploitByRow;this.exploits[o].setSelectionMode(0);this.exploits[o].item_margin=5;this.exploits[o].onItemCreate=e.hitch(this,"addCardClass");for(var a in this.gamedatas.exploitTypes){card_exploit=this.gamedatas.exploitTypes[a];this.exploits[o].addItemType(a,0,g_gamethemeurl+"img/sprite-cards-reb.jpg",2*this.exploitSpritePosition[a])}this.scoreCtrl[i].setValue(parseInt(e.byId("player_score_"+i).innerHTML))}}},initDiceSelection:function(t){this.myDlg;t.selectMode=null==t.selectMode||"flat"!=t.selectMode&&"sides"!=t.selectMode?"flat":t.selectMode;t.nbToSelect=null==t.nbToSelect||t.nbToSelect;t.sameSelectable=null!=t.sameSelectable&&t.sameSelectable;t.mirrorVisible=null==t.mirrorVisible||t.mirrorVisible;t.mirrorSelectable=null!=t.mirrorSelectable&&t.mirrorSelectable;t.limitSelfSelect=null!=t.limitSelfSelect&&t.limitSelfSelect;t.canCancel=null==t.canCancel||t.canCancel;t.title=null==t.title?_("Select something"):t.title;t.cardData=null==t.cardData?"":t.cardData;t.onChange=null==t.onChange?"":t.onChange;t.onConfirm=null==t.onConfirm?"":t.onConfirm;t.action=null==t.action?"":t.action;t.hideMirror=null!=t.hideMirror&&t.hideMirror;if(null==t.dices||0==t.dices.length){""!=t.actionCancel&&this[t.actionCancel]();return!1}t.canCancel=!0;this.diceSelectionArgs=t;var i=t.dices,s=this;t.cardData&&(t.title=_(t.cardData.name)+" - "+t.title);t.title=t.title.replace("${nb}",t.nbToSelect);this.myDlg=new ebg.popindialog;this.myDlg.create("myDialogUniqueId");this.myDlg.setTitle(t.title);t.hideMirror?this.myDlg.replaceCloseCallback((function(){s.myDlg.hide();e.removeClass("btn-show-chooser","hide")})):this.myDlg.replaceCloseCallback((function(){s.myDlg.destroy()}));t.canCancel||this.myDlg.hideCloseIcon();var o="";for(var a in i){var r=[],n=i[a];original_dice=e.byId("player-"+n.player_id+"-dice-3D-"+n.dice).parentElement;dice_clone=e.clone(original_dice);"sides"==t.selectMode?e.removeClass(dice_clone,"roll"):this.prepareDice(dice_clone);e.addClass(dice_clone,"clone");e.setAttr(dice_clone,"id","clone-"+n.player_id+"-"+n.dice);e.query(".side",dice_clone).removeClass("die-lining die-lining-fire die-lining-moon");r.push("clickable");if("sides"==t.selectMode&&t.mirrorVisible&&n.is_mirror)t.mirrorSelectable||r.push("disabled","mirror");else if("sides"==t.selectMode&&n.is_mirror)continue;o+=this.format_block("jstpl_dice_selector_item",{player_id:n.player_id,player_name:this.gamedatas.players[n.player_id].name,player_color:this.gamedatas.players[n.player_id].color,classes:r.join(" "),dice:n.dice,html:dice_clone.outerHTML})}o+=this.format_block("jstpl_bga_btn",{color:"blue",classes:"",id:"dice-selector-confirm",text:this.translatableTexts.confirm});r=[];t.sameSelectable&&r.push("same");r.push(t.selectMode);var l=this.format_block("jstpl_dice_selector",{html:o,classes:r.join(" ")});this.myDlg.setContent(l);this.myDlg.show();"looseThrow"==t.cardData.action&&e.query(".standard_popin").addClass("minotaur");this.connexions["dice-selector"]=e.query("#dice-selector .clickable").map((function(t){return e.connect(t,"onclick",s,"onChangeDiceSelection")}));this.connexions["dice-selector"].confirm=e.connect($("dice-selector-confirm"),"onclick",this,"onConfirmDiceSelection");return!0},endDiceSelection:function(){if(this.connexions.hasOwnProperty("dice-selector")){e.forEach(this.connexions["dice-selector"],(function(t){e.disconnect(t)}));delete this.connexions["dice-selector"]}this.myDlg.hide();this.diceSelectionArgs={}},cancelLocalStateAndClean:function(){this.cleanClientStateArgs();this.cancelLocalStateEffects()},cancelLocalStateEffects:function(){this.restoreServerGameState()},onClickAutoHammer:function(t){e.stopEvent(t);var i=e.attr(t.target,"data-enabled");this.ajaxcall("/diceforge/diceforge/actAutoHammer.html",{lock:!0,enable:1!=i},this,(function(e){}),(function(e){}))},onClickFilterRolls:function(t){e.stopEvent(t);var i=t.target.id.match(/btn-filter-log-([a-zA-Z0-9]+)/)[1],s=this;if(this.currentFilter!=i){this.currentFilter=i;this.resetFilterRolls();e.query(t.target).removeClass("bgabutton_gray").addClass("bgabutton_blue");e.query(".log").forEach((function(t){var o=t.innerText||t.textContent,a=s.translatableTexts.rollsLogsTextSearch.replace("${logPlayerName}",i);-1==o.indexOf(a)&&e.addClass(t,"hide")}))}else{this.resetFilterRolls();this.currentFilter=""}},resetFilterRolls:function(){e.query(".btn-filter-log").removeClass("bgabutton_blue").addClass("bgabutton_gray");e.query(".log.hide").removeClass("hide")},prepareChoiceState:function(e,t){this.clientStateArgs.sides=e.args[this.player_id].sides;this.clientStateArgs.ajaxAction=t;if("celestialMirror"!=e.args.celestial&&"chooseSide"!=e.args.celestial||e.args[this.player_id].hasOwnProperty("twins")&&(!e.args[this.player_id].hasOwnProperty("twins")||0!=e.args[this.player_id].twins)){if(e.args[this.player_id].firstFinish){$("pagemaintitletext").innerHTML=this.translatableTexts.celestialChooseSides;this.selfSides.activate("OneSidePerDice","onClickConfirmGoddessCard")}else if("side"==e.args[this.player_id].action){this.clientStateArgs.side_choice=e.args[this.player_id].side_choice;l=[];var i=0,s=0;if(e.args.hasOwnProperty("card")&&"oustAll"==e.args.card.action){if("oustAll"==e.args.card.action){ousted=e.args[this.player_id].oustedPlayerId;for(var o in this.gamedatas.players)if(o!=ousted)for(a=1;a<=2;a++){r="mirror"==this.lastSideUp[o][a].type;l.push({player_id:o,dice:a,is_mirror:r});r&&i++}if(i)for(a=1;a<=2;a++){r="mirror"==this.lastSideUp[ousted][a].type;l.push({player_id:ousted,dice:a,is_mirror:r});r&&s++}n={title:this.translatableTexts.mirrorDialogTitle,selectMode:"sides",nbToSelect:e.args[this.player_id].mirror,canCancel:0,sameSelectable:2==s||2==e.args[this.player_id].mirror?1:0,limitSelfSelect:1==s&&i?1:0,dices:l,action:"onClickSideChoiceConfirm",hideMirror:!0};e.args.hasOwnProperty("card")&&(n.cardData=e.args.card)}}else{for(var o in this.gamedatas.players)if(o!=this.player_id)for(var a=1;a<=2;a++){var r="mirror"==this.lastSideUp[o][a].type;l.push({player_id:o,dice:a,is_mirror:r});r&&i++}if(i)for(var a=1;a<=2;a++){var r="mirror"==this.lastSideUp[this.player_id][a].type;l.push({player_id:this.player_id,dice:a,is_mirror:r});r&&s++}e.args.hasOwnProperty("card")&&("4Throws"==e.args.card.action||"4ThrowsTransform"==e.args.card.action)&&s>1&&(s=1);var n={title:this.translatableTexts.mirrorDialogTitle,selectMode:"sides",nbToSelect:e.args[this.player_id].mirror,canCancel:0,sameSelectable:(2==s||2==e.args[this.player_id].mirror)&&e.args[this.player_id].mirror>1?1:0,limitSelfSelect:1==s&&i?1:0,dices:l,action:"onClickSideChoiceConfirm",hideMirror:!0};e.args.hasOwnProperty("card")&&(n.cardData=e.args.card)}this.initDiceSelection(n)}else if("ressource"==e.args[this.player_id].action||"mazeRessource"==e.args[this.player_id].action){this.triple=e.args[this.player_id].triple;this.clientStateArgs.possibilities=e.args[this.player_id].possibilities;this.addRessourceButtons(e.args[this.player_id].action)}}else switch(e.args.celestial){case"celestialMirror":this.clientStateArgs.side_choice={side1:!0,side2:!1};var l=[];for(var o in this.gamedatas.players)for(var a=1;a<=2;a++)l.push({player_id:o,dice:a,is_mirror:"mirror"==this.lastSideUp[o][a].type});e={title:this.translatableTexts.celestialMirror,selectMode:"sides",nbToSelect:1,mirrorVisible:!1,dices:l,canCancel:0,action:"onClickSideChoiceConfirm",hideMirror:!0};this.initDiceSelection(e);break;case"chooseSide":$("pagemaintitletext").innerHTML=this.translatableTexts.celestialChooseSide;this.selfSides.activate("OneSide","onClickConfirmCelestialMirror")}},addRessourceButtons:function(e){var t=this.clientStateArgs.sides[0];this.clientStateArgs.side_type=t.type;if(this.clientStateArgs.possibilities.length>1){t.hasOwnProperty("type")&&("ressource"==e?"tritonToken"==t.type?$("pagemaintitletext").innerHTML=$("pagemaintitletext").innerHTML+'  <div id="type_'+t.type+'" class="token-small token-triton"></div>':$("pagemaintitletext").innerHTML=$("pagemaintitletext").innerHTML+'  <div id="type_'+t.type+'" class="bside '+this.sideClass[t.type]+'"></div>':"mazeRessource"==e&&($("pagemaintitletext").innerHTML=$("pagemaintitletext").innerHTML+this.mazeTextToIcon("[m"+t.type+"]")));var i=0;for(var s in this.clientStateArgs.possibilities){var o=this.clientStateArgs.possibilities[s];o.text=this.replaceTextWithIcons(o.text);this.addActionButton("resChoice"+i+"_"+o.num+"_"+o["[G]"]+"_"+o["[H]"]+"_"+o["[FS]"]+"_"+o["[MS]"]+"_"+o["[VP]"]+"_"+o["[AS]"]+"_"+o["[L]"]+"_"+o["[M]"],o.text,"onClickRessourceChoice",null,null,"gray");i++}}else if(1==this.clientStateArgs.possibilities.length){this.ajaxcall("/diceforge/diceforge/"+this.clientStateArgs.ajaxAction+".html",{lock:!0,side:t.type,"side-gold":this.clientStateArgs.possibilities[0]["[G]"],"side-hammer":this.clientStateArgs.possibilities[0]["[H]"],"side-vp":this.clientStateArgs.possibilities[0]["[VP]"],"side-moonshard":this.clientStateArgs.possibilities[0]["[MS]"],"side-fireshard":this.clientStateArgs.possibilities[0]["[FS]"],"side-ancientshard":this.clientStateArgs.possibilities[0]["[AS]"],"side-loyalty":this.clientStateArgs.possibilities[0]["[L]"],"side-maze":this.clientStateArgs.possibilities[0]["[M]"],sideNum:this.clientStateArgs.possibilities[0].num},this,(function(e){}),(function(e){}));return}},hasHammer:function(t){var i=e.byId("hammer_container_p"+t);return!e.hasClass(i,"hide")},divYou:function(){var e=this.isSpectator?"000000":this.gamedatas.players[this.player_id].color,t="";this.gamedatas.players[this.player_id]&&this.gamedatas.players[this.player_id].color_back&&(t="background-color:#"+this.gamedatas.players[this.player_id].color_back+";");return'<span style="font-weight:bold;color:#'+e+";"+t+'">'+__("lang_mainsite","You")+"</span>"},refreshStocks:function(){if(!this.isEmptyObject(this.pools))for(var e in this.pools){var t=this.pools[e];"function"==typeof t.resetItemsPosition&&t.resetItemsPosition()}if(!this.isEmptyObject(this.exploits))for(var e in this.exploits){var i=this.exploits[e];"function"==typeof i.resetItemsPosition&&i.resetItemsPosition()}},activateSpecificCards:function(t){if(t){e.query("#powers_p"+this.getActivePlayerId()+" .powers-small").removeClass("unusable used");for(var i in t){var s=e.byId("power-"+i);if(t[i].hasOwnProperty("unusable"))e.addClass(s,"unusable");else{e.addClass(s,"usable");if(this.isCurrentPlayerActive()){e.addClass(s,"clickable");"companion"==t[i].type&&(this.connexions[s.id]=e.connect(s,"onclick",this,"onClickUseCompanion"))}}}}},activateReinforcement:function(t){if(t){e.query("#powers_p"+this.getActivePlayerId()+" .powers-small").removeClass("unusable used");for(var i in t){var s=e.byId("power-"+i);if(s)if(t[i].hasOwnProperty("unusable"))e.addClass(s,"unusable");else{e.addClass(s,"usable");t[i].hasOwnProperty("choice")||(t[i].choice="truc");if(this.isCurrentPlayerActive()){e.addClass(s,"clickable");e.setAttr(s,"data-choice",t[i].choice);this.connexions[s.id]=e.connect(s,"onclick",this,"onClickReinforcement"+this.capitalize(t[i].type))}}}this.isCurrentPlayerActive()?e.query("#powers_p"+this.getActivePlayerId()+" .powers-small:not(.unusable):not(.clickable)").addClass("used"):e.query("#powers_p"+this.getActivePlayerId()+" .powers-small:not(.unusable):not(.usable)").addClass("used")}},deactivateReinforcement:function(){var t=this;e.query("#powers_p"+this.getActivePlayerId()+" .powers-small").forEach((function(i){e.removeClass(i,"clickable usable");if(t.isCurrentPlayerActive()){e.disconnect(t.connexions[i.id]);delete t.connexions[i.id]}}))},activateTritonToken:function(t=!1){var i=this;if(this.player_id==this.turnPlayerId){e.query("#tokens_p"+this.turnPlayerId+" .token-triton").forEach((function(t){e.addClass(t,"clickable");i.connexions.hasOwnProperty(t.id)||(i.connexions[t.id]=e.connect(t,"onclick",i,"onClickUseTritonToken"))}));e.query("#tokens_p"+this.turnPlayerId+" .token-scepter").forEach((function(t){t.querySelector(".ressource-display").innerHTML>=4?t.classList.add("clickable"):t.classList.remove("clickable");i.connexions.hasOwnProperty(t.id)||(i.connexions[t.id]=e.connect(t,"onclick",i,"onClickUseScepter"))}))}else t&&this.isCurrentPlayerActive()&&e.query("#tokens_p"+this.player_id+" .token-triton").forEach((function(t){e.addClass(t,"clickable");i.connexions.hasOwnProperty(t.id)||(i.connexions[t.id]=e.connect(t,"onclick",i,"onClickUseTritonToken"))}))},deactivateTritonToken:function(){var t=this;this.player_id==this.turnPlayerId&&e.query("#tokens_p"+this.turnPlayerId+" .token-triton").forEach((function(i){e.removeClass(i,"clickable");e.disconnect(t.connexions[i.id]);delete t.connexions[i.id]}))},onClickUseTritonToken:function(){var e={descriptionmyturn:"",args:{}};e.descriptionmyturn=this.translatableTexts.tritonTokenDescriptionMyTurn;e.args[this.player_id]={action:"ressource",triple:1,sides:[],possibilities:""};e.args[this.player_id].sides[0]={id:"",type:"tritonToken",num:0};e.args[this.player_id].possibilities=[];e.args[this.player_id].possibilities.push({"[G]":0,"[H]":0,"[FS]":2,"[MS]":0,"[VP]":0,text:"2[FS]",num:0});e.args[this.player_id].possibilities.push({"[G]":0,"[H]":0,"[FS]":0,"[MS]":2,"[VP]":0,text:"2[MS]",num:0});e.args[this.player_id].possibilities.push({"[G]":6,"[H]":0,"[FS]":0,"[MS]":0,"[VP]":0,text:"6[G]",num:0});if(this.hasHammer(this.player_id)){e.args[this.player_id].possibilities.push({"[G]":5,"[H]":1,"[FS]":0,"[MS]":0,"[VP]":0,text:"5[G] 1[H]",num:0});e.args[this.player_id].possibilities.push({"[G]":4,"[H]":2,"[FS]":0,"[MS]":0,"[VP]":0,text:"4[G] 2[H]",num:0});e.args[this.player_id].possibilities.push({"[G]":3,"[H]":3,"[FS]":0,"[MS]":0,"[VP]":0,text:"3[G] 3[H]",num:0});e.args[this.player_id].possibilities.push({"[G]":2,"[H]":4,"[FS]":0,"[MS]":0,"[VP]":0,text:"2[G] 4[H]",num:0});e.args[this.player_id].possibilities.push({"[G]":1,"[H]":5,"[FS]":0,"[MS]":0,"[VP]":0,text:"1[G] 5[H]",num:0});e.args[this.player_id].possibilities.push({"[G]":0,"[H]":6,"[FS]":0,"[MS]":0,"[VP]":0,text:"6[H]",num:0})}this.removeActionButtons();this.setClientState("tritonToken",e)},doForge:function(t,i,s,o){var a=e.query(".pools div[id$='_item_"+s+"']")[0],r=a.id.match(/pool-([0-9]+)/)[1],n=document.getElementById("side_"+i).parentElement,l=document.getElementById("side_flat_"+i),c=document.getElementById("side_flat_"+i).parentElement;n.innerHTML="";e.place(this.format_block("jstpl_bside",{id:s,class:this.sideClass[o],type:o}),a.id);e.place(this.format_block("jstpl_flat_bside",{id:s,class:this.sideClass[o],type:o}),a.id);e.destroy(l);this.slideToPlus("side_"+s,n.id).play();this.slideToPlus("side_flat_"+s,c.id).play();this.pools[r].removeFromStockById(s);var d=e.query(n).closest(".dice-result")[0];e.removeClass(d,"sideup1 sideup2 sideup3 sideup4 sideup5 sideup6");e.addClass(d,"sideup"+n.getAttribute("data-numside"));var h=c.id.substr(-1,1);this.lastSideUp[t][h]={id:s,type:o}},getCurrentSideUp:function(e,t){return this.lastSideUp[e][t]},activateExploits:function(t){t||(t=this.exploitSlot);for(var i in t){slot=t[i];this.exploits[slot].setSelectionMode(1);this.connexions["exploit"+slot]=e.connect(this.exploits[slot],"onChangeSelection",this,"onExploitSelection")}},deactivateExploits:function(){for(var t in this.exploitSlot){slot=this.exploitSlot[t];if(this.connexions.hasOwnProperty("exploit"+slot)){e.disconnect(this.connexions["exploit"+slot]);delete this.connexions["exploit"+slot]}this.exploits[slot].setSelectionMode(0)}},cleanClientStateArgs:function(){this.clientStateArgs={}},onClickForgePoolSide:function(e){if(null!=e){var t=e.match(/pool-([0-9]+)/)[1];if(this.pools[t].getSelectedItems().length){for(var i in this.pools)i!=t&&this.pools[t].getSelectedItems().length&&this.pools[i].unselectAll();this.selectForge.activateSelfSides();2==this.prefs[100].value&&0==this.selectForge.isForging&&this.deactivateExploits()}else{this.selectForge.deactivateSelfSides();2==this.prefs[100].value&&0==this.selectForge.isForging&&this.activateExploits()}}},onClickForgeSelfSide:function(t,i=!1){var s=t.target.id.match(/side_flat_([0-9]+)/)[1];e.query(".bside.selected").removeClass("selected");e.query(t.target).addClass("selected");if("G1"==e.getAttr(t.target.id,"data-type")||i){this.selectForge.sideToReplace=s;this.selectForge.getSideToForge()&&this.onClickConfirmSideSelection()}else this.confirmationDialog(this.translatableTexts.forgeOriginalSide,e.hitch(this,(function(){this.onClickForgeSelfSide(t,!0)})))},onClickDraftButton:function(e){if(this.checkAction("actDraft",!0)){var t=this.exploits.draft.getSelectedItems(),i=t.length;if(i<=0){this.showMessage(this.translatableTexts.draftNoCardSelectedError,"error");return}if(i>1){this.showMessage(this.translatableTexts.draftTooManyCardSelectedError,"error");return}this.ajaxcall("/diceforge/diceforge/actDraft.html",{lock:!0,card_type:t[0].type},this,(function(e){}),(function(e){}))}},onExploitSelection:function(t){var i=t.match(/exploit-([A-Z0-9]+)/)[1];if(this.exploits[i].getSelectedItems().length){var s=this.exploits[i].getSelectedItems()[0].id;this.isTouchScreen?this.confirmationDialog(this.translatableTexts.buyExploitConfirmation,e.hitch(this,(function(){this.onClickBuyExploitCheck(s,i)}))):this.onClickBuyExploitCheck(s,i)}},playerActionCancel:function(){this.removeActionButtons();this.setClientState("playerAction",this.statesInfo.playerAction)},onClickCerberus:function(t){e.stopEvent(t);var i="yes"==t.target.id.match(/cerberus_([a-z]+)/)[1]?1:0;this.checkAction("actUseCerberusToken")&&this.ajaxcall("/diceforge/diceforge/actUseCerberusToken.html",{lock:!0,use:i},this,(function(e){}),(function(e){}))},onClickConfirmGoddessCard:function(){var e=this;this.checkAction("actSideChoice",!0)&&(sides=this.pluck(this.selfSides.sidesSelected,"type"),this.ajaxcall("/diceforge/diceforge/actSideChoice.html",{lock:!0,side1:sides[0],side2:sides[1]},this,(function(t){e.selfSides.deactivate()}),(function(e){})))},onClickConfirmCelestialMirror:function(){var e=this;this.selfSides;if(this.checkAction("actSideChoice",!0)){sides=this.pluck(this.selfSides.sidesSelected,"type"),sideNum=this.selfSides.sidesSelected[0].diceNum;sideTemp={};sideTemp[1]=null;sideTemp[2]=null;sideTemp[sideNum]=sides[0];this.ajaxcall("/diceforge/diceforge/actSideChoice.html",{lock:!0,side1:sideTemp[1],side2:sideTemp[2]},this,(function(t){e.selfSides.deactivate()}),(function(e){}))}},onClickConfirmSideSelection:function(){var e=this;this.checkAction("actBuyForge",!0)&&this.ajaxcall("/diceforge/diceforge/actBuyForge.html",{lock:!0,sideToForge:this.selectForge.getSideToForge(),sideToReplace:this.selectForge.getSideToReplace()},this,(function(t){e.selectForge.deactivateSelfSides();e.selectForge.deactivatePoolSides()}),(function(t){e.selectForge.resetSelection()}))},onClickConfirmMazePath:function(e){var t=e.target.id;-1==t.indexOf("maze")&&(t=e.target.parentElement.id);button_info=t.split("_");this.checkAction("actChooseMazePath")&&this.ajaxcall("/diceforge/diceforge/actChooseMazePath.html",{lock:!0,newPosition:button_info[1]},this,(function(e){}),(function(e){}))},onClickConfirmMazeTreasure:function(e){var t=e.target.id;-1==t.indexOf("maze")&&(t=e.target.parentElement.id);button_info=t.split("_");this.checkAction("actChooseTreasure")&&this.ajaxcall("/diceforge/diceforge/actChooseTreasure.html",{lock:!0,treasure:button_info[2]},this,(function(e){}),(function(e){}))},onClickConfirmPuzzleMaze:function(t){e.stopEvent(t);this.checkAction("actPuzzleMaze")&&this.ajaxcall("/diceforge/diceforge/actPuzzleMaze.html",{lock:!0},this,(function(e){}),(function(e){}))},onClickConfirmMazePower:function(t){e.stopEvent(t);this.checkAction("actMazePowerConfirm")&&this.ajaxcall("/diceforge/diceforge/actMazePowerConfirm.html",{lock:!0,use:!0},this,(function(e){}),(function(e){}))},onClickRejectMazePower:function(t){e.stopEvent(t);this.checkAction("actMazePowerConfirm")&&this.ajaxcall("/diceforge/diceforge/actMazePowerConfirm.html",{lock:!0,use:!1},this,(function(e){}),(function(e){}))},onClickConfirmPuzzleCelestial:function(t){e.stopEvent(t);this.checkAction("actPuzzleCelestial")&&this.ajaxcall("/diceforge/diceforge/actPuzzleCelestial.html",{lock:!0},this,(function(e){}),(function(e){}))},onClickMerchantStepOne:function(e){var t=e.target.id;if(-1==t.indexOf("merchant"))t=e.target.parentElement.id;else{button_info=t.split("_");if("0"==button_info[1])this.checkAction("actReinforcement",!0)&&this.ajaxcall("/diceforge/diceforge/actReinforcement.html",{lock:!0,card_id:this.clientStateArgs.card_id,merchant_nbupgrade:button_info[1]},this,(function(e){}),(function(e){}));else{this.clientStateArgs.merchantNbUpgrade=button_info[1];this.setClientState("merchantSecondStep",{descriptionmyturn:this.translatableTexts.merchantSecondStep})}}},onClickMerchantThirdStep:function(t,i,s){if(void 0!==t){null==s&&(s=[]);i=void 0!==i?i:0;met="onClickMerchantConfirm";if(e.query(".current-player-play-area .dice-flat .bside.selected")){e.query(".current-player-play-area .dice-flat .bside").removeClass("selected");e.query(".pool").removeClass("clickable")}var o=null,a=0,r=this;elementId=t.target.id;e.query("#"+elementId).addClass("selected");this.clientStateArgs.old_side=elementId.match(/([0-9]+)/)[1];side_type=e.getAttr(elementId,"data-type");for(var n in this.sidesInit)if(-1!=this.sidesInit[n].indexOf(side_type)){o=n;break}if(null===o)a=0;else for(var n in this.initPools)if(-1!=this.initPools[n].indexOf(parseInt(o))){a=n;break}sourceBigPool=a;if(7!=a)if((a=parseInt(a)+parseInt(this.clientStateArgs.merchantNbUpgrade)+parseInt(i))>7&&"onClickCelestialUpgrade"!=this.clientStateArgs.callback)this.showMessage(this.translatableTexts.merchantTooMuchUpgrade,"error");else{a>7&&(a=7);newBonus=i;if(0==i)for(n=parseInt(sourceBigPool)+1;n<=a;n++){nbSide=0;for(var l in this.initPools[n])this.pools.hasOwnProperty(this.initPools[n][l])&&(nbSide+=this.pools[this.initPools[n][l]].count());0!=nbSide&&s.push(n)}newBonus;if(i==newBonus){0!=i&&s.push(a);nbSide=0;for(var l in this.initPools[a])this.pools.hasOwnProperty(this.initPools[a][l])&&(nbSide+=this.pools[this.initPools[a][l]].count());if(0==nbSide&&a<7)this.onClickMerchantThirdStep(t,i+1,s);else if(0!=nbSide||7!=a){this.clientStateArgs.hasOwnProperty("callback")&&(met=this.clientStateArgs.callback);for(var c in s){popo=s[c];for(var l in this.initPools[popo])if(r.pools.hasOwnProperty(this.initPools[popo][l])){e.query("#pool-"+this.initPools[popo][l]).addClass("clickable");r.pools[this.initPools[popo][l]].setSelectionMode(1);r.connexions["pool"+this.initPools[popo][l]]=e.connect(r.pools[this.initPools[popo][l]],"onChangeSelection",r,met)}}}else{this.showMessage(this.translatableTexts.upgradeNotPossible,"error");this.restoreServerGameState()}}else this.onClickMerchantThirdStep(t,newBonus,s)}else{this.showMessage(this.translatableTexts.upgradeNotPossible,"error");this.restoreServerGameState()}}},onClickMerchantConfirm:function(){this.clientStateArgs.card_id,this.clientStateArgs.merchantNbUpgrade,this.selectForge.getSideToForge(),this.clientStateArgs.old_side;this.checkAction("actReinforcement",!0)?this.ajaxcall("/diceforge/diceforge/actReinforcement.html",{lock:!0,card_id:this.clientStateArgs.card_id,merchant_nbupgrade:this.clientStateArgs.merchantNbUpgrade,sideToForge:this.selectForge.getSideToForge(),sideToReplace:this.clientStateArgs.old_side},this,(function(e){}),(function(e){})):this.checkAction("actCelestialUpgrade",!0)&&this.ajaxcall("/diceforge/diceforge/actCelestialUpgrade.html",{lock:!0,sideToForge:this.selectForge.getSideToForge(),sideToReplace:this.clientStateArgs.old_side},this,(function(e){}),(function(e){}))},onClickCancelCelestial:function(){this.checkAction("actCancelCelestial",!0)&&this.ajaxcall("/diceforge/diceforge/actCancelCelestial.html",{lock:!0},this,(function(e){}),(function(e){}))},onClickCelestialUpgrade:function(){this.selectForge.getSideToForge(),this.clientStateArgs.old_side;this.checkAction("actCelestialUpgrade",!0)&&this.ajaxcall("/diceforge/diceforge/actCelestialUpgrade.html",{lock:!0,sideToForge:this.selectForge.getSideToForge(),sideToReplace:this.clientStateArgs.old_side},this,(function(e){}),(function(e){}))},onClickRessourceChoice:function(e){var t=e.target.id;-1==t.indexOf("resChoice")&&(t=e.target.parentElement.id);if(-1!=t.indexOf("resChoice")){button_info=t.split("_");var i=this.clientStateArgs.side_type;this.ajaxcall("/diceforge/diceforge/"+this.clientStateArgs.ajaxAction+".html",{lock:!0,side:i,"side-gold":button_info[2],"side-hammer":button_info[3],"side-vp":button_info[6],"side-moonshard":button_info[5],"side-fireshard":button_info[4],"side-ancientshard":button_info[7],"side-loyalty":button_info[8],"side-maze":button_info[9],sideNum:button_info[1]},this,(function(e){0==button_info[1]&&this.cancelLocalStateEffects()}),(function(e){}))}},onClickBuyExploitWithAncient:function(e){var t=e.target.id;-1==t.indexOf("exploitChoice")&&(t=e.target.parentElement.id);if(-1!=t.indexOf("exploitChoice")){button_info=t.split("_");let e=this.clientStateArgs.actionData.card_id;this.ajaxcall("/diceforge/diceforge/actBuyExploit.html",{lock:!0,card_id:e,fireshard:button_info[1],moonshard:button_info[2],ancientshard:button_info[3]},this,(function(e){}),(function(e){}))}},onClickMemoryChoose:function(e){var t=e.target.id;-1==t.indexOf("memory")&&(t=e.target.parentElement.id);this.clientStateArgs.choice=t;this.setClientState("memoryIsland",{descriptionmyturn:this.translatableTexts.memoryIsland})},onClickMemorySetup:function(e){var t=e.target.id;-1==t.indexOf("position")&&(t=e.target.parentElement.id);button_info=t.split("-");this.ajaxcall("/diceforge/diceforge/actMemoryToken.html",{lock:!0,token:this.clientStateArgs.memory.key,island:button_info[1],choice:this.clientStateArgs.choice},this,(function(e){}),(function(e){}))},onClickSideChoiceConfirm:function(e){if(e&&0!=e.length){var t=[];t.lock=!0;var i=0;if(this.clientStateArgs.side_choice.side1){t.side1=this.getCurrentSideUp(e[i].player_id,e[i].dice_num).type;i++}else t.side1=null;this.clientStateArgs.side_choice.side2?t.side2=this.getCurrentSideUp(e[i].player_id,e[i].dice_num).type:t.side2=null;this.clientStateArgs.side_choice.side98?t.side98=this.getCurrentSideUp(e[i].player_id,e[i].dice_num).type:t.side98=null;this.checkAction("actSideChoice")&&this.ajaxcall("/diceforge/diceforge/actSideChoice.html",t,this,(function(e){this.endDiceSelection()}),(function(e){}))}},onClickEndForge:function(t){e.stopEvent(t);this.checkAction("actEndForge")&&this.ajaxcall("/diceforge/diceforge/actEndForge.html",{lock:!0},this,(function(e){}),(function(e){}))},onClickCancelForge:function(t){e.stopEvent(t);this.playerActionCancel()},onClickCancelPlayerAction:function(t){e.stopEvent(t);this.playerActionCancel()},onClickHelpForgeButton:function(t){e.stopEvent(t);switch(t.target.id.match(/help_button_([a-zA-Z0-9]+)/)[1]){case"side3x":case"sideShip":case"sideMirror":case"boarForge":this.displayTempOverlay(["dice1-flat-player-"+this.player_id,"dice2-flat-player-"+this.player_id]);var i=document.getElementById("dice1-flat-player-"+this.player_id);window.scrollTo({left:i.offsetLeft,top:i.offsetTop,behavior:"smooth"});break;case"shieldForge":this.displayTempOverlay("pool-12");i=document.getElementById("pool-12");window.scrollTo({left:i.offsetLeft,top:i.offsetTop,behavior:"smooth"})}},onClickPlayerAction:function(t,i){e.stopEvent(t);i=void 0!==i&&i;var s=t.target.id.match(/player_action_button_([a-zA-Z]+)/)[1];"forge"==s?this.gotoChooseForge():"exploit"==s?this.gotoChooseExploit():"end"==s&&(i?this.checkAction("actEndPlayerTurn")&&this.ajaxcall("/diceforge/diceforge/actEndPlayerTurn.html",{lock:!0},this,(function(e){}),(function(e){})):this.confirmationDialog(this.translatableTexts.confirmEndTurn,e.hitch(this,(function(){this.onClickPlayerAction(t,!0)}))))},gotoChooseForge:function(e){(e=null==e?{}:e).descriptionmyturn=e.hasOwnProperty("descriptionmyturn")?e.descriptionmyturn:this.translatableTexts.forgeDescriptionMyTurn;this.removeActionButtons();this.setClientState("chooseForge",e)},gotoChooseExploit:function(e){(e=null==e?{}:e).descriptionmyturn=e.hasOwnProperty("descriptionmyturn")?e.descriptionmyturn:this.translatableTexts.exploitDescriptionMyTurn;this.removeActionButtons();this.setClientState("chooseExploit",e)},onClickBoarPlayer:function(e){var t=e.target.parentNode.id.split("_")[2];null==t&&(t=e.target.id.split("_")[2]);null!=t&&this.checkAction("actExploitBoar")&&this.ajaxcall("/diceforge/diceforge/actExploitBoar.html",{lock:!0,forgePlayerId:t},this,(function(e){}),(function(e){}))},onClickReinforcementDoe:function(t){e.stopEvent(t);var i=t.target.id.match(/power-([0-9]+)/)[1];this.clientStateArgs.actionData={card_id:i};var s={title:this.translatableTexts.silverHindDialogTitle,selectMode:"flat",nbToSelect:1,dices:[{player_id:this.player_id,dice:1},{player_id:this.player_id,dice:2}],action:"onDiceSelectionDoe"};this.initDiceSelection(s)},onClickReinforcementOracle:function(t){e.stopEvent(t);var i=t.target.id.match(/power-([0-9]+)/)[1];this.clientStateArgs.actionData={card_id:i};var s={title:this.translatableTexts.oracleHindDialogTitle,selectMode:"flat",nbToSelect:1,dices:[{player_id:this.player_id,dice:1},{player_id:this.player_id,dice:2}],action:"onDiceSelectionDoe"};this.initDiceSelection(s)},onClickUseScepter:function(t){e.stopEvent(t);var i=t.target;if(i.id.match(/token-scepter-([0-9]+)-([0-9]+)/)){var s=i.id.match(/token-scepter-([0-9]+)-([0-9]+)/)[2],o=e.byId("countscepter_"+s).innerHTML,a=0;if(!(o<4)){a=o<6?1:2;this.clientStateArgs.actionData={scepter_id:s,amount:a};this.setClientState("useScepter",{descriptionmyturn:this.translatableTexts.scepterTokenDescriptionMyTurn})}}},onClickScepterFireshard:function(e){this.onClickScepter("fireshard")},onClickScepterMoonshard:function(e){this.onClickScepter("moonshard")},onClickScepter:function(e){this.checkAction("actUseScepter")&&this.ajaxcall("/diceforge/diceforge/actUseScepter.html",{lock:!0,scepter_id:this.clientStateArgs.actionData.scepter_id,resource_type:e},this,(function(e){}),(function(e){}))},onClickCancelScepter:function(e){this.checkAction("actCancelScepter")&&this.ajaxcall("/diceforge/diceforge/actCancelAllScepters.html",{lock:!0},this,(function(e){}),(function(e){}))},onDiceSelectionDoe:function(e){this.checkAction("actReinforcement")&&this.ajaxcall("/diceforge/diceforge/actReinforcement.html",{lock:!0,card_id:this.clientStateArgs.actionData.card_id,dice_num:e[0].dice_num},this,(function(e){this.endDiceSelection()}),(function(e){}))},onDiceSelectionAncestor:function(e){this.checkAction("actAncestorSelect")&&this.ajaxcall("/diceforge/diceforge/actAncestorSelect.html",{lock:!0,dice_num:e[0].dice_num},this,(function(e){this.endDiceSelection()}),(function(e){}))},onDiceSelection4Throws:function(e){this.checkAction("actExploitEnigma")&&this.ajaxcall("/diceforge/diceforge/actExploitEnigma.html",{lock:!0,die_number:parseInt(e[0].dice_num)},this,(function(e){this.endDiceSelection()}),(function(e){}))},onClickReinforcementAncient:function(t){e.stopEvent(t);var i=t.target.id.match(/power-([0-9]+)/)[1];if(this.checkAction("actReinforcement")){this.ajaxcall("/diceforge/diceforge/actReinforcement.html",{lock:!0,card_id:i},this,(function(e){}),(function(e){}))}},onClickReinforcementLight:function(t){e.stopEvent(t);var i=t.target.id.match(/power-([0-9]+)/)[1];this.clientStateArgs.side_choice={side1:!0,side2:!1};this.clientStateArgs.reinforcement=i;var s=[];for(var o in this.gamedatas.players)for(var a=1;a<=2;a++){var r="mirror"==this.lastSideUp[o][a].type;s.push({player_id:o,dice:a,is_mirror:r})}var n={title:_("Select a side"),selectMode:"sides",nbToSelect:1,dices:s,canCancel:0,action:"onClickSelectLight"};this.initDiceSelection(n)},onClickSelectLight:function(e){if(e&&0!=e.length){side=this.getCurrentSideUp(e[0].player_id,e[0].dice_num).id;if(this.checkAction("actReinforcement")){this.ajaxcall("/diceforge/diceforge/actReinforcement.html",{lock:!0,card_id:this.clientStateArgs.reinforcement,dice_num:side},this,(function(e){this.endDiceSelection()}),(function(e){}))}}},onClickReinforcementMerchant:function(t){e.stopEvent(t);var i=t.target.id.match(/power-([0-9]+)/)[1];this.clientStateArgs.card_id=i;this.clientStateArgs.merchantNbUpgrade=e.query("#power-"+i)[0].innerHTML;""==this.clientStateArgs.merchantNbUpgrade&&(this.clientStateArgs.merchantNbUpgrade=1);this.setClientState("merchantFirstStep",{descriptionmyturn:this.translatableTexts.merchantFirstStep})},onClickReinforcementTree:function(t){e.stopEvent(t);var i=t.target,s=e.attr(i,"data-choice"),o=i.id.match(/power-([0-9]+)/)[1];if("false"==s)this.actReinforcementTree(o,null);else{this.addActionButton(o+"_gold",this.replaceTextWithIcons("3 [G] 1 [VP]"),"onClickConfirmTree",null,null,"gray");this.addActionButton(o+"_vp",this.replaceTextWithIcons("2 [VP]"),"onClickConfirmTree",null,null,"gray")}},onClickConfirmTree:function(t){e.stopEvent(t);var i=t.target;button_info=i.id.split("_");this.actReinforcementTree(button_info[0],button_info[1])},actReinforcementTree:function(e,t){if(this.checkAction("actReinforcement")){this.ajaxcall("/diceforge/diceforge/actReinforcement.html",{lock:!0,card_id:e,owl:t},this,(function(e){}),(function(e){}))}},onClickUseCompanion:function(t){e.stopEvent(t);this.confirmationDialog(this.translatableTexts.convertCompanion,e.hitch(this,(function(){this.onClickConfirmCompanion(t)})))},onClickConfirmCompanion:function(e){var t=e.target.id.match(/power-([0-9]+)/)[1];this.checkAction("actUseCompanion")&&this.ajaxcall("/diceforge/diceforge/actUseCompanion.html",{lock:!0,card_id:t},this,(function(e){}),(function(e){}))},onClickReinforcementCompanion:function(t){e.stopEvent(t);var i=t.target.id.match(/power-([0-9]+)/)[1];if(this.checkAction("actReinforcement")){this.ajaxcall("/diceforge/diceforge/actReinforcement.html",{lock:!0,card_id:i},this,(function(e){}),(function(e){}))}},onClickReinforcementNymphe:function(t){e.stopEvent(t);var i=t.target.id.match(/power-([0-9]+)/)[1];if(this.checkAction("actReinforcement")){this.ajaxcall("/diceforge/diceforge/actReinforcement.html",{lock:!0,card_id:i},this,(function(e){}),(function(e){}))}},onClickReinforcementOwl:function(e){var t=e.target.id.match(/power-([0-9]+)/)[1];this.clientStateArgs.card_id=t;this.setClientState("owlChoose",{descriptionmyturn:this.translatableTexts.owlDescriptionMyTurn})},onClickReinforcementGuardian:function(e){var t=e.target.id.match(/power-([0-9]+)/)[1];this.clientStateArgs.card_id=t;this.setClientState("guardianChoose",{descriptionmyturn:this.translatableTexts.owlDescriptionMyTurn})},onClickOwlMoonshard:function(e){this.onRessourceSelectionOwl("moonshard")},onClickOwlFireshard:function(e){this.onRessourceSelectionOwl("fireshard")},onClickOwlGold:function(e){this.onRessourceSelectionOwl("gold")},onClickOwlHammer:function(e){this.onRessourceSelectionOwl("hammer")},onClickGuardianAncient:function(e){this.onRessourceSelectionOwl("ancient")},onClickGuardianLoyalty:function(e){this.onRessourceSelectionOwl("loyalty")},onRessourceSelectionOwl:function(e){this.checkAction("actReinforcement")&&this.ajaxcall("/diceforge/diceforge/actReinforcement.html",{lock:!0,card_id:this.clientStateArgs.card_id,owl:e},this,(function(e){}),(function(e){}))},onClickConfirmActionReroll1:function(e){this.onClickConfirmAction("reroll",1)},onClickConfirmActionReroll2:function(e){this.onClickConfirmAction("reroll",2)},onClickConfirmActionRerollCelestial:function(e){this.onClickConfirmAction("rerollCelestial",0)},onClickConfirmActionForgeShip:function(e){this.onClickConfirmAction("forge",0)},onClickConfirmActionGetRessource:function(e){this.onClickConfirmAction("ressource",0)},onClickConfirmActionGetRessource1:function(e){this.onClickConfirmAction("ressource",1)},onClickConfirmActionGetRessource2:function(e){this.onClickConfirmAction("ressource",2)},onClickConfirmActionGetCelestial:function(e){this.onClickConfirmAction("celestial",0)},onClickConfirmActionGetMisfortune1:function(e){this.onClickConfirmMisfortune("ressource",1)},onClickConfirmActionGetMisfortune2:function(e){this.onClickConfirmMisfortune("ressource",2)},onClickConfirmMisfortune:function(e,t){this.checkAction("actActionMisfortune")&&this.ajaxcall("/diceforge/diceforge/actActionMisfortune.html",{lock:!0,actionChoice:e,die:t},this,(function(e){}),(function(e){}))},onClickConfirmAction:function(e,t){this.checkAction("actActionChoice")&&this.ajaxcall("/diceforge/diceforge/actActionChoice.html",{lock:!0,actionChoice:e,die:t},this,(function(e){}),(function(e){}))},onClickReinforcementPrePass:function(t){e.query(".current-player-play-area .powers-small.used").length!=e.query(".current-player-play-area .powers-small").length?this.confirmationDialog(this.translatableTexts.passReinforcementConfirmation,e.hitch(this,(function(){this.onClickReinforcementPass()}))):this.onClickReinforcementPass()},onClickReinforcementPass:function(e){this.checkAction("actReinforcementPass")&&this.ajaxcall("/diceforge/diceforge/actReinforcementPass.html",{lock:!0},this,(function(e){}),(function(e){}))},onClickSecondActionPass:function(e){this.onClickSecondAction(!1,e)},onClickSecondActionPlay:function(e){this.onClickSecondAction(!0,e)},onClickSecondAction:function(e,t){var i=t.target.id;-1==i.indexOf("secondAction")&&(i=t.target.parentElement.id);if(-1!=i.indexOf("secondAction")){button_info=i.split("_");this.checkAction("actSecondAction")&&this.ajaxcall("/diceforge/diceforge/actSecondAction.html",{lock:!0,play:e,fireshard:button_info[1],ancientshard:button_info[3]},this,(function(e){}),(function(e){}))}},onClickForgeShipPass:function(t){e.stopEvent(t);var i=t.target.id.match(/forge_ship_pass_([0-9]+)/)[1];this.checkAction("actForgeShipPass")&&this.ajaxcall("/diceforge/diceforge/actForgeShipPass.html",{lock:!0,sideNum:i},this,(function(e){}),(function(e){}))},onClickForgeNymphPass:function(t){e.stopEvent(t);this.checkAction("actForgeNymphPass")&&this.ajaxcall("/diceforge/diceforge/actForgeNymphPass.html",{lock:!0},this,(function(e){}),(function(e){}))},onClickBuyExploitCheck:function(e,t){if(this.clientStateArgs.free)this.onClickBuyExploit(e,t);else if(0!=this.getAvailableAncientShard()){this.clientStateArgs.actionData={card_id:e,slot:t};this.setClientState("buyWithAncientshard",{descriptionmyturn:this.translatableTexts.buyWithAncientShardDescriptionMyTurn})}else this.onClickBuyExploit(e,t)},getAvailableAncientShard:function(){let t=e.byId("ancientshardcount_p"+this.player_id);return null!=t&&0!=t.innerHTML?t.innerHTML:0},onClickBuyExploit:function(e,t){var i=this;this.checkAction("actBuyExploit")&&this.ajaxcall("/diceforge/diceforge/actBuyExploit.html",{lock:!0,card_id:e,fireshard:0,moonshard:0,ancientshard:0},this,(function(e){}),(function(s){i.exploits[t].unselectItem(e)}));this.clientStateArgs.free&&(this.clientStateArgs.free=!1)},onChangeDiceSelection:function(t){var i=e.query(t.target).closest(".clickable")[0],s=i.id.match(/dice-num-([0-9]+)-([0-9]+)/),o=e.query("#dice-selector .selected"),a=this.getSpanQuantityDiceSelection(),r=o.length;if(!e.hasClass(i,"disabled")){if(1==this.diceSelectionArgs.limitSelfSelect){var n=!1;if(r){var l=this;e.forEach(o,(function(e,t){if(!n){var i=e.id.match(/dice-num-([0-9]+)-([0-9]+)/);i[1]==l.player_id&&(n=i)}}))}var c=1==s[2]?2:1,d=e.query("#dice-selector #dice-num-"+this.player_id+"-"+c)[0];n&&s[1]==n[1]&&s[2]==n[2]?e.hasClass(d,"mirror")&&!this.diceSelectionArgs.mirrorSelectable||e.removeClass(d,"disabled"):s[1]==this.player_id&&e.addClass(d,"disabled")}if(1==this.diceSelectionArgs.nbToSelect){o.removeClass("selected");e.addClass(i,"selected")}else this.diceSelectionArgs.nbToSelect==o.length||this.diceSelectionArgs.nbToSelect==a?e.hasClass(i,"selected")&&this.diceSelectionArgs.sameSelectable?this.decreaseDiceSelection(i):e.hasClass(i,"selected")&&e.removeClass(i,"selected"):this.diceSelectionArgs.sameSelectable?this.increaseDiceSelection(i):e.hasClass(i,"selected")?e.removeClass(i,"selected"):e.addClass(i,"selected");"function"==typeof this.diceSelectionArgs.onChange&&this[this.diceSelectionArgs.onChange]()}},increaseDiceSelection:function(t){var i=e.query(t).query(".num")[0],s=i.innerText||i.textContent;s=""==s?1:parseInt(s)+1;i.innerHTML=s;e.addClass(t,"selected")},decreaseDiceSelection:function(t){var i=e.query(t).query(".num")[0],s=i.innerText||i.textContent;if(""!=s){if(0==(s=parseInt(s)-1)){s="";e.removeClass(t,"selected")}i.innerHTML=s}},onConfirmDiceSelection:function(t){var s;s=this.diceSelectionArgs.sameSelectable?this.getSpanQuantityDiceSelection():e.query("#dice-selector .selected").length;if(this.diceSelectionArgs.nbToSelect==s){var o=[];this.diceSelectionArgs.sameSelectable?e.query("#dice-selector .selected .num").forEach((function(t){var s=t.innerText||t.textContent;if(s=""==s?0:parseInt(s)){selectionEl=e.query(t).closest(".selected")[0];for(i=1;i<=s;i++){diceInfo=selectionEl.id.match(/dice-num-([0-9]+)-([0-9]+)/);o.push({player_id:diceInfo[1],dice_num:diceInfo[2]})}}})):e.query("#dice-selector .selected").forEach((function(e){diceInfo=e.id.match(/dice-num-([0-9]+)-([0-9]+)/);o.push({player_id:diceInfo[1],dice_num:diceInfo[2]})}));"function"==typeof this.diceSelectionArgs.onConfirm&&this[this.diceSelectionArgs.onConfirm](o);e.hasClass("btn-show-chooser","hide")||e.addClass("btn-show-chooser","hide");this[this.diceSelectionArgs.action](o)}},getSpanQuantityDiceSelection:function(){var t=0;e.query("#dice-selector .selected .num").forEach((function(e){var i=e.innerText||e.textContent;i=""==i?0:parseInt(i);t+=i}));return t},onChangeMazeOpacity:function(t){e.stopEvent(t);var i=document.getElementById("maze-opacity"),s=document.getElementById("maze-board"),o=i.value;document.cookie="dfMazeOpacity="+o;s.className="";s.classList.add("opacity-"+10*o)},onClickMazePulse:function(t){e.stopEvent(t);var i=document.getElementById("maze-board");i.classList.toggle("pulse");var s=i.classList.contains("pulse");document.cookie="dfMazePulse="+s},setupNotifications:function(){e.subscribe("notifBlessing",this,"notifBlessing");e.subscribe("notifBeginTurn",this,"notifBeginTurn");e.subscribe("notifLastTurn",this,"notifLastTurn");e.subscribe("notifEndTurn",this,"notifEndTurn");e.subscribe("notifBeginPlayerTurn",this,"notifBeginPlayerTurn");e.subscribe("notifSecondAction",this,"notifSecondAction");e.subscribe("updateCounters",this,"notifUpdateCounters");this.notifqueue.setSynchronous("notifBlessing",500);e.subscribe("notifSideForged",this,"notifSideForged");this.notifqueue.setSynchronous("notifSideForged",2e3);e.subscribe("notifMovePawn",this,"notifMovePawn");this.notifqueue.setSynchronous("notifMovePawn",1e3);e.subscribe("notifExploitBuy",this,"notifBuyExploit");this.notifqueue.setSynchronous("notifExploitBuy",750);e.subscribe("notifOusting",this,"notifOusting");this.notifqueue.setSynchronous("notifOusting",1e3);e.subscribe("notifAddReinforcement",this,"notifAddReinforcement");e.subscribe("notifAddToken",this,"notifAddToken");e.subscribe("notifAddTokenScepter",this,"notifAddTokenScepter");e.subscribe("notifHammerVP",this,"notifHammerVP");e.subscribe("notifRemoveHammer",this,"notifRemoveHammer");e.subscribe("notifBeginScoring",this,"doNothing");this.notifqueue.setSynchronous("notifBeginScoring",2500);e.subscribe("notifEndScoring",this,"notifEndScoring");this.notifqueue.setSynchronous("notifEndScoring",1e3);e.subscribe("notifEndScoringTitan",this,"notifEndScoringTitan");this.notifqueue.setSynchronous("notifEndScoringTitan",1e3);e.subscribe("notifUseCerberusToken",this,"notifUseCerberusToken");e.subscribe("notifUseScepter",this,"notifUseScepter");e.subscribe("notifUseTritonToken",this,"notifUseTritonToken");e.subscribe("notifDraft",this,"notifDraft");e.subscribe("notifAutoHammer",this,"notifAutoHammer");e.subscribe("notifDiceSwitch",this,"notifDiceSwitch");this.notifqueue.setSynchronous("notifDiceSwitch",3e3);e.subscribe("notifPauseDice",this,"doNothing");this.notifqueue.setSynchronous("notifPauseDice",1500);e.subscribe("notifCompanion",this,"notifCompanion");e.subscribe("notifUseCompanion",this,"notifUseCompanion");e.subscribe("notifCelestialRoll",this,"notifCelestialRoll");e.subscribe("notifMazeMove",this,"notifMazeMove");e.subscribe("notifMazeTreasure",this,"notifMazeTreasure");e.subscribe("twinUpdate",this,"notifTwinUpdate");e.subscribe("notifResetTwins",this,"notifResetTwins");e.subscribe("notifTitanMove",this,"notifTitanMove");e.subscribe("notifMemorySetup",this,"notifMemorySetup");e.subscribe("notifRemoveMemoryToken",this,"notifRemoveMemoryToken")},notifTwinUpdate:function(t){e.query("#token-"+t.args.player_id+"-"+t.args.card_id).addClass("unusable")},notifResetTwins:function(t){e.query(".ressources-effect-twins.unusable").removeClass("unusable")},doNothing:function(e){},notifUpdateCounters:function(e){for(var t in e.args)if(t.match(/countscepter_([0-9]+)/)){var i=e.args[t].counter_value;$scepter=document.getElementById(t).parentNode;$scepter.classList.remove("token-scepter-0","token-scepter-1","token-scepter-2","token-scepter-3","token-scepter-4","token-scepter-5","token-scepter-6");$scepter.classList.add("token-scepter-"+i);null!=document.querySelector(".current-player-play-area #"+t)&&this.isCurrentPlayerActive()&&(i>=4?$scepter.classList.add("clickable"):$scepter.classList.remove("clickable"))}this.updateCounters(e.args)},notifBlessing:function(e){var t=e.args.dice1,i=e.args.dice2,s=e.args.player_id;if(e.args.roll){t&&this.rollDice(s,1,t);i&&this.rollDice(s,2,i)}},notifCelestialRoll:function(e){this.rollCelestialDice(e.args.sideCelestial)},notifUseCompanion:function(e){this.notifCompanion({args:{card_id:"power-"+e.args.card,val:9999}})},notifAutoHammer:function(t){var i=document.getElementById("btn-auto-hammer"),s="enable"==t.args.done?1:0;e.attr(i,"data-enabled",s);i.innerHTML=0==s?this.translatableTexts.autoHammerEnableButton:this.translatableTexts.autoHammerDisableButton},notifDiceSwitch:function(e){for(var t in e.args.playerSwitch)if(0!=t){from_player=e.args.playerSwitch[t];this.moveDices(from_player,t)}},moveDices:function(t,i){var s=this,o=e.query("#player-container-"+t+" #player-"+t+"-dice-3D-1")[0],a=e.query("#player-container-"+t+" #player-"+t+"-dice-3D-2")[0];this.prepareDice(o.parentElement);this.prepareDice(a.parentElement);this.slideToPlus(o.id,"dice1-result-player-"+i,0,(function(){s.refreshDice(i,1)})).play();this.slideToPlus(a.id,"dice2-result-player-"+i,0,(function(){s.refreshDice(i,2)})).play()},refreshDice:function(t,i){var s=document.querySelector("#dice"+i+"-result-player-"+t+" .dice");s.id="player-"+t+"-dice-3D-"+i;var o=Array.from(s.querySelectorAll(".bside")),a=[];for(var r in o){if(!this.isNumber(r))break;var n=o[r],l=n.className.split(" "),c="";for(var d in l)"bside"!=l[d]&&(c=l[d]);var h=n.id.match(/side_([0-9]+)/)[1],p=1==i?"fire":"moon";a[r]={id:h,class:c,type:Array.from(this.sideClass).indexOf(c)}}a.dice=i;a.player_id=t;a.type=p;var u="player-"+t+"-dice-"+i;e.empty(u);e.place(this.format_block("jstpl_dice_flat",a),u);var m=e.query("#dice"+i+"-result-player-"+t+" .dice")[0];e.empty(m);e.place(this.format_block("jstpl_dice",a),m)},notifDraft:function(t){for(var i=t.args.slot,s=Object.keys(t.args.exploit).length-1;s>=0;s--){var o=Object.keys(t.args.exploit)[s],a=t.args.exploit[o];null==this.gamedatas.exploits[i]&&(this.gamedatas.exploits[i]={});this.gamedatas.exploits[i][o]=a;this.exploits[i].addItemType(i,0,g_gamethemeurl+"img/sprite-cards-reb.jpg",2*this.exploitSpritePosition[a.type]);this.exploits[i].addToStockWithId(i,o)}"celestial"==t.args.exploitName&&e.removeClass("celestial_dice","hide");if(this.gamedatas.exploits.hasOwnProperty(i)){var r=Object.keys(this.gamedatas.exploits[i]).length;e.place(this.format_block("jstpl_card_number",{slot:i,nb:r}),"exploit-"+i,"first")}},notifBeginTurn:function(e){document.getElementById("turncount").className="turn"+e.args.turn;document.getElementById("current-turn-number").innerHTML=e.args.turn},notifLastTurn:function(t){var i=document.getElementById("nb-turns-container");e.addClass(i,"lastTurn");i.innerHTML=this.translatableTexts.lastTurnMessage},notifEndTurn:function(t){e.query(".powers-small").removeClass("used")},notifBeginPlayerTurn:function(t){this.hideDraftBoard();this.deactivateTritonToken();e.query(".powers-small").removeClass("used");0!=e.query(".player-board.active").length&&e.removeClass(e.query(".player-board.active")[0],"active");e.addClass("overall_player_board_"+t.args.player_id,"active");0!=e.query(".play-area.active").length&&e.removeClass(e.query(".play-area.active")[0],"active");e.addClass("player-container-"+t.args.player_id,"active");this.turnPlayerId=t.args.player_id;this.activateTritonToken()},notifSecondAction:function(t){e.removeClass("action_p"+this.getActivePlayerId(),"hide")},notifOusting:function(e){this.slideToObject("player_"+this.colors[e.args.ousted_player],"position-init-"+this.colors[e.args.ousted_player]).play()},notifSideForged:function(e){this.doForge(e.args.player_id,e.args.old_side,e.args.side,e.args.side_type_name)},notifMemorySetup:function(t){var i=t.args.token.split("_"),s="";let o="";if("1"==t.args.side){s="sun";o="2 [L] 1 [FS]"}else{s="moon";o="2 [AS] 1 [MS]"}e.place(this.format_block("jstpl_memory_id",{id:t.args.token,type:this.memoryMap[i[0]]+s}),"pile-"+t.args.player_id);this.slideToPlus(t.args.token,"memory-"+t.args.island,0,(function(){})).play();token_owner='<span style="font-weight:bold;color:#'+this.gamedatas.players[t.args.player_id].color+'">'+this.gamedatas.players[t.args.player_id].name+"</span>";this.addTooltipHtml(t.args.token,this.format_block("jstpl_tooltip_title",{title:_("Memory token of ")+token_owner,description:_("Gain ")+this.ressourcesTextToIcon(o)}))},notifRemoveMemoryToken:function(t){this.removeTooltip(t.args.tokenId);e.destroy(t.args.tokenId)},notifBuyExploit:function(t){var i=t.args.pile,s=t.args.player_id;this.removeTooltip("exploit-"+t.args.card_pos+"_item_"+t.args.card_id);if(-1==i.indexOf("table")){this.exploits[i].addToStockWithId(t.args.card_type,t.args.card_id,"exploit-"+t.args.card_pos+"_item_"+t.args.card_id);this.exploits[t.args.card_pos].removeFromStockById(t.args.card_id)}else{this.exploits["pile-"+s].addToStockWithId(t.args.card_type,t.args.card_id,"exploit-"+t.args.card_pos+"_item_"+t.args.card_id);this.exploits[t.args.card_pos].removeFromStockById(t.args.card_id)}if("chest"==t.args.card_type){document.getElementById("gold_max_p"+s).innerHTML=parseInt(document.getElementById("gold_max_p"+s).innerHTML)+4;document.getElementById("fire_max_p"+s).innerHTML=parseInt(document.getElementById("fire_max_p"+s).innerHTML)+3;document.getElementById("moon_max_p"+s).innerHTML=parseInt(document.getElementById("moon_max_p"+s).innerHTML)+3}else if("hammer"==t.args.card_type){var o=e.byId("hammer_container_p"+s);this.gamedatas.players[s].remainingHammer++;$elHammerLeft=e.query("#hammersleft_p"+s)[0];$elHammerLeft.innerHTML=this.gamedatas.players[s].remainingHammer;if(e.hasClass(o,"hide")){e.removeClass(o,"hide");this.gamedatas.counters["hammercount_p"+s]={counter_name:"hammercount_p"+s,counter_value:"0"};e.addClass("hammer_p"+s,"ressources-hammer1");e.query("#hammercount_p"+s)[0].innerHTML=0;e.query("#hammers_p"+s)[0].innerHTML=1}else e.removeClass($elHammerLeft,"hide");e.place(this.format_block("jstpl_ressource_id",{id:"hammer_ptemp",size:"small",type:"hammer"}),"exploit-M1");this.slideToPlus("hammer_ptemp","hammer_container_p"+s,0,(function(){e.destroy("hammer_ptemp")})).play()}else if(null!=this.classEffect[t.args.card_type]){var a="token-"+s+"-"+t.args.card_id;e.place(this.format_block("jstpl_ressource_id",{id:a,size:"small",type:this.classEffect[t.args.card_type]}),"action_p"+s,"before");this.addPowerToolTip(a,t.args.card_type)}var r=e.byId("card-counter-"+t.args.card_pos);(nb=this.exploits[t.args.card_pos].count())?r.innerHTML=this.exploits[t.args.card_pos].count():e.destroy(r)},notifMovePawn:function(e){"init"==e.args.island?position="position-init-"+this.colors[e.args.player_color]:position="position-"+e.args.island;this.slideToObject("player_"+this.colors[e.args.player_color],position).play()},notifMazeMove:function(e){this.slideToPlus(this.colors[e.args.player_color]+"-golem","maze-tile-"+e.args.position).play()},notifTitanMove:function(e){this.slideToPlus(this.colors[e.args.player_color]+"-player","titan-tile-"+e.args.position).play()},notifMazeTreasure:function(e){this.addTreasureToolTip(e.args.position,e.args.treasure)},notifAddReinforcement:function(t){if("merchant"==t.args.power){$merchant=document.querySelector("#powers_p"+t.args.player_id+" .power-merchant");if(null!=$merchant){$merchant.innerHTML=parseInt($merchant.innerHTML)+1;return}}e.place(e.place(this.format_block("jstpl_power",{id:t.args.card_id,type:t.args.power}),"powers_p"+t.args.player_id),"powers_p"+t.args.player_id);this.addPowerToolTip("power-"+t.args.card_id,t.args.power);if("merchant"==t.args.power){$merchant=document.querySelector("#powers_p"+t.args.player_id+" .power-merchant");$merchant.innerHTML=1}},notifAddToken:function(t){e.place(e.place(this.format_block("jstpl_token_id",{size:"small",type:t.args.token,player_id:t.args.player_id,num:t.args.card_id}),"tokens_p"+t.args.player_id),"tokens_p"+t.args.player_id);this.addPowerToolTip("token-"+t.args.token+"-"+t.args.player_id+"-"+t.args.card_id,t.args.token);this.activateTritonToken()},notifAddTokenScepter:function(t){e.place(e.place(this.format_block("jstpl_token_scepter",{size:"small",type:t.args.token,player_id:t.args.player_id,num:t.args.card_id}),"tokens_p"+t.args.player_id),"tokens_p"+t.args.player_id).classList.add("token-"+t.args.token+"-0");this.addPowerToolTip("token-"+t.args.token+"-"+t.args.player_id+"-"+t.args.card_id,t.args.token);this.gamedatas.counters["countscepter_"+t.args.card_id]={counter_name:"countscepter_"+t.args.card_id,counter_value:"0"};this.activateTritonToken()},notifHammerVP:function(t){var i=t.args.player_id;e.removeClass("hammer_p"+i,"ressources-hammer"+t.args.hammer_phase);if(1==t.args.hammer_phase)e.addClass("hammer_p"+i,"ressources-hammer2");else{e.addClass("hammer_p"+i,"ressources-hammer1");this.gamedatas.players[i].remainingHammer--}$elHammerLeft=e.query("#hammersleft_p"+i)[0];$elHammerLeft.innerHTML=this.gamedatas.players[i].remainingHammer;this.gamedatas.players[i].remainingHammer<=1&&e.addClass("hammersleft_p"+i,"hide")},notifRemoveHammer:function(t){e.removeClass("hammer_container_p"+t.args.player_id,"ressources-hammer2");e.addClass("hammer_container_p"+t.args.player_id,"hide")},notifUseCerberusToken:function(t){var i=e.query(".token-cerberus","tokens_p"+t.args.player_id)[0];e.destroy(i)},notifUseScepter:function(e){this.updateScepter("moon",e.args.player_id,e.args.moonshard);this.updateScepter("fire",e.args.player_id,e.args.fireshard)},updateScepter(t,i,s){var o=e.query("#scepter_"+t+"_"+i)[0];if(o)if(0!=s){e.removeClass(o,"hide");o.innerHTML="(+"+s+")"}else{e.addClass(o,"hide");o.innerHTML=""}},notifUseTritonToken:function(t){var i=e.query(".token-triton","tokens_p"+t.args.player_id)[0];e.destroy(i)},notifEndScoring:function(e){var t="final-card-p"+e.args.player_id;this.scoreCtrl[e.args.player_id].incValue(e.args.vp);this.exploits[t].addToStockWithId(e.args.card_type,e.args.card_id,e.args.pile+"_item_"+e.args.card_id);this.exploits[e.args.pile].removeFromStockById(e.args.card_id)},notifEndScoringTitan:function(e){this.scoreCtrl[e.args.player_id].incValue(e.args.vp)},notifCompanion:function(t){if(9999==t.args.val)e.query("#"+t.args.card_id).addClass("hide");else{e.query("#"+t.args.card_id).removeClass("power-companion-"+parseInt(t.args.val-1));e.query("#"+t.args.card_id).addClass("power-companion-"+parseInt(t.args.val))}},hideDraftBoard:function(){if(0==e.query("#draft-container.hide").length){e.query("#draft-container").addClass("hide");e.query(".container-play-area").removeClass("hide")}},rollDice:function(e,t,i){var s=document.getElementById("player-"+e+"-dice-3D-"+t).parentElement;if("number"==typeof i)var o="sideup"+i;else if(null!=i){var a=!!s.getElementsByClassName(this.sideClass[i]).length&&s.getElementsByClassName(this.sideClass[i])[0],r=(o="sideup"+a.parentElement.getAttribute("data-numside"),a.id.match(/side_([0-9]+)/)[1]);this.lastSideUp[e][t]={id:r,type:i}}else o="sideup"+(Math.floor(6*Math.random())+1);this.prepareDice(s);s.classList.add("roll");s.classList.add(o)},rollCelestialDice:function(e,t){var i=document.getElementById("celestial_dice").parentElement;t=void 0===t||t;if(null!=e)var s="sideup"+(!!i.getElementsByClassName(this.sideClass[e]).length&&i.getElementsByClassName(this.sideClass[e])[0]).parentElement.getAttribute("data-numside");else s="sideup"+(Math.floor(6*Math.random())+1);this.prepareDice(i);t&&i.classList.add("roll");i.classList.add(s)},prepareDice:function(e){e.classList.remove("roll","sideup1","sideup2","sideup3","sideup4","sideup5","sideup6");e.offsetWidth},slideToPlus:function(t,i,s,o){s=null==s?0:s;this.attachToNewParent(t,i);var a={node:t,top:0,left:0,unit:"px",duration:1500,delay:s};null!=o&&"function"==typeof o&&(a.onEnd=o);return e.fx.slideTo(a)},debugResourcesAll:function(){this.ajaxcall("/diceforge/diceforge/debugResourcesAll.html",{lock:!0},this,(function(e){}),(function(e){}))},capitalize:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},duplicateObject:function(e){return JSON.parse(JSON.stringify(e))},getKeys:function(e){var t=[];for(var i in e)t.push(i);return t},swapKeys:function(e){var t={};for(var i in e)t[e[i]]=i;return t},isEmptyObject:function(e){for(var t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0},isNumber:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},getMyCookie:function(e){var t=document.cookie.split(";");if(0==t.length)return null;for(var i in t){var s=t[i].trim();[param,value]=s.split("=");if(param==e)return value}return null},search:function(e,t,i){i=void 0===i?"name":i;for(var s=0;s<e.length;s++)if(e[s][i]===t)return e[s]},pluck:function(e,t){return e.map((function(e){return e[t]}))}})}));